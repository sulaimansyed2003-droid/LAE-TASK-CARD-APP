<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LAE Task Card App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background-color: #800000; /* Batik Air maroon */
      color: #fff;
      padding: 15px;
      text-align: center;
    }
    .container {
      padding: 20px;
    }
    .hidden {
      display: none;
    }
    .section {
      margin-top: 20px;
      padding: 15px;
      background: #f4f4f4;
      border-radius: 8px;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.1);
    }
    button {
      background-color: #800000;
      color: #fff;
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #b22222;
    }
    input, select {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .task-card {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      background: #fff;
      box-shadow: 0px 2px 4px rgba(0,0,0,0.1);
    }
    .task-card h3 {
      margin: 0 0 5px 0;
      color: #800000;
    }
    .clock {
      font-weight: bold;
      margin-left: 10px;
    }
    nav {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>LAE Task Card App</h1>
    <span class="clock" id="clock"></span>
  </header>

  <div class="container">
    <!-- Login Section -->
    <div id="login-section" class="section">
      <h2>Login</h2>
      <input type="text" id="login-name" placeholder="Enter Name" />
      <input type="text" id="login-id" placeholder="Enter ID" />
      <select id="login-role">
        <option value="lae">LAE</option>
        <option value="officer">Officer</option>
      </select>
      <button onclick="login()">Login</button>
    </div>

    <!-- Navigation -->
    <div id="nav-section" class="section hidden">
      <h2>Navigation</h2>
      <nav>
        <button onclick="toggleSection('tasks-section')">All Tasks</button>
        <button onclick="toggleSection('assigned-section')">Assigned Tasks</button>
        <button onclick="toggleSection('done-section')">Done</button>
        <button onclick="toggleSection('productivity-section')">Productivity Dashboard</button>
        <button onclick="toggleSection('attendance-section')">Attendance</button>
        <button onclick="toggleSection('roster-section')">Roster Upload/Preview</button>
      </nav>
    </div>

    <!-- Tasks Section -->
    <div id="tasks-section" class="section hidden">
      <h2>All Tasks</h2>
      <div id="tasks-list"></div>
    </div>

    <!-- Assigned Section -->
    <div id="assigned-section" class="section hidden">
      <h2>Assigned Tasks</h2>
      <div id="assigned-list"></div>
    </div>

    <!-- Done Section -->
    <div id="done-section" class="section hidden">
      <h2>Completed Tasks</h2>
      <div id="done-list"></div>
    </div>

    <!-- Productivity Section -->
    <div id="productivity-section" class="section hidden">
      <h2>Productivity Dashboard</h2>
      <div id="productivity-data"></div>
    </div>

    <!-- Attendance Section -->
    <div id="attendance-section" class="section hidden">
      <h2>Attendance (Officer View)</h2>
      <div id="attendance-data"></div>
    </div>

    <!-- Roster Section -->
    <div id="roster-section" class="section hidden">
      <h2>Roster Upload & Preview</h2>
      <input type="file" id="roster-file" />
      <button onclick="previewRoster()">Upload & Preview</button>
      <div id="roster-preview"></div>
    </div>
    <!-- keep above sections, then include the XLSX lib + app script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      // ====== App State ======
      let currentUser = null;

      // Keep your original staff list; you can extend it freely
      const staffNames = [
        "ABDUL FATAH BIN IBRAHIM",
        "MOHD HAFIZ SAZWAN BIN ZAM ZAM",
        "MOHAMMAD ZULKIFLEE BIN HUSSIN",
        "DING JU SHENG",
        "LEE YOONG JUN",
        "MUHAMMAD NAZIF BIN ABDUL MALEK"
      ];

      // Basic fallback roster (weekday strings) — real roster comes from Excel upload
      const laeRoster = {
        "ABDUL FATAH BIN IBRAHIM": ["Mon","Tue","Wed","Thu","Fri"],
        "MOHD HAFIZ SAZWAN BIN ZAM ZAM": ["Mon","Tue","Thu","Fri"],
        "MOHAMMAD ZULKIFLEE BIN HUSSIN": ["Tue","Wed","Thu"],
        "DING JU SHENG": ["Mon","Wed","Fri"],
        "LEE YOONG JUN": ["Tue","Thu","Fri"],
        "MUHAMMAD NAZIF BIN ABDUL MALEK": ["Mon","Tue","Wed","Thu","Fri"]
      };

      // Task model mirrors your columns; persisted to localStorage
      let allTasks = [];
      let attendance = {}; // name -> boolean (Present)
      // Roster parsing state
      let rosterMatrix = [];
      let rosterHeaderRow = -1;
      let rosterNameCol = 0;
      let rosterPreviewVisible = false;

      // ====== Persistence ======
      function loadSavedData(){
        try {
          const saved = localStorage.getItem("batikAirAppData");
          if(saved){
            const data = JSON.parse(saved);
            if(Array.isArray(data.tasks)) allTasks = data.tasks;
            if(Array.isArray(data.rosterMatrix)) {
              rosterMatrix = data.rosterMatrix;
            }
          }
        } catch(e){ console.error("Load error:", e); }
      }
      function saveAppData(){
        const data = { tasks: allTasks, rosterMatrix };
        localStorage.setItem("batikAirAppData", JSON.stringify(data));
      }
      loadSavedData();

      // ====== MYT Clock ======
      function updateClock(){
        const nowMY = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kuala_Lumpur'}));
        const s = nowMY.toLocaleString('en-GB', {
          weekday:'short', day:'2-digit', month:'short', year:'numeric',
          hour:'2-digit', minute:'2-digit', second:'2-digit'
        }) + " MYT";
        const el = document.getElementById("clock");
        if(el) el.textContent = s;
      }
      updateClock();
      setInterval(updateClock, 1000);

      // ====== Login / Nav ======
      function login(){
        const name = document.getElementById('login-name').value.trim();
        const id   = document.getElementById('login-id').value.trim();
        const role = document.getElementById('login-role').value;

        if(!name || !id || !role){ alert("Fill all fields (Name, ID, Role)."); return; }

        currentUser = { name, id, role: role.toUpperCase() };
        // Show nav
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('nav-section').classList.remove('hidden');

        // Default to All Tasks
        toggleSection('tasks-section');
        // Precompute attendance display
        computeSimpleAttendance();
        // Render
        renderAllTasks();
        renderAssigned();
        renderDone();
        renderProductivity();
        renderAttendance();
      }

      function toggleSection(id){
        const sections = [
          'tasks-section',
          'assigned-section',
          'done-section',
          'productivity-section',
          'attendance-section',
          'roster-section'
        ];
        sections.forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');

        // On entry, refresh relevant views
        if(id==='tasks-section') renderAllTasks();
        if(id==='assigned-section') renderAssigned();
        if(id==='done-section') renderDone();
        if(id==='productivity-section') renderProductivity();
        if(id==='attendance-section') renderAttendance();
        if(id==='roster-section') { /* wait for user to upload file; preview handled separately */ }
      }

      // ====== Helpers ======
      function dayShortMYT(){
        const nowMY = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kuala_Lumpur'}));
        return nowMY.toLocaleDateString("en-US",{weekday:'short'}); // Mon/Tue/...
      }

      function isPresentByFallback(name){
        const today = dayShortMYT(); // e.g., "Mon"
        const arr = laeRoster[name] || [];
        return arr.includes(today);
      }

      // Simple attendance map from fallback (overridden by roster upload if present)
      function computeSimpleAttendance(){
        staffNames.forEach(n => {
          attendance[n] = isPresentByFallback(n);
        });
      }

      function canLAEMarkDone(t){
        if(!currentUser || currentUser.role!=="LAE") return false;
        if(!t.assignedTo || t.assignedTo !== currentUser.name) return false;

        // Present by roster (if parsed) OR fallback
        const present = isPresentFromRoster(t.assignedTo) ?? isPresentByFallback(t.assignedTo);
        return !!present;
      }

      // ====== Task Rendering ======
      function cardHTML(t, i){
        const meta = `
          <div><b>ATA:</b> ${t.ata || ""}</div>
          <div><b>Task Card Num / AMM Ref:</b> ${t.card || ""}</div>
          <div><b>Description:</b> ${t.description || ""}</div>
          <div><b>Tools / Testset:</b> ${t.tools || ""}</div>
          <div><b>Consumables / MSL:</b> ${t.consumables || ""}</div>
          <div><b>Remarks:</b> ${t.remarks || ""}</div>
          <div><b>Duration / Manhour:</b> ${t.manhour || "N/A"}</div>
          <div><b>Due:</b> ${t.due || "N/A"}</div>
          <div><b>Assigned To:</b> <span style="color:#800000;font-weight:bold">${t.assignedTo || "None"}</span></div>
          <div><b>Status:</b> ${t.done ? "✅ Done" : "⏳ Pending"}</div>
        `;

        // Officer assign control
        const assignCtl = (currentUser && currentUser.role==="OFFICER") ? `
          <div style="margin-top:8px;">
            Assign:
            <select onchange="assign(${i}, this.value)">
              <option value="">Assign to...</option>
              ${staffNames.map(n => `<option value="${n}" ${t.assignedTo===n?'selected':''}>${n}</option>`).join("")}
            </select>
          </div>
        ` : ``;

        // LAE mark done checkbox (only if allowed)
        const canMark = canLAEMarkDone(t);
        const markCtl = canMark ? `
          <div style="margin-top:8px;">
            <label>
              <input type="checkbox" ${t.done?"checked":""} onchange="markDone(${i}, this.checked)">
              Mark Done
            </label>
          </div>
        ` : ``;

        return `
          <div class="task-card ${t.done?'done':''}">
            <h3>ATA ${t.ata || "-"}</h3>
            ${meta}
            ${assignCtl}
            ${markCtl}
          </div>
        `;
      }

      function renderAllTasks(){
        const root = document.getElementById('tasks-list');
        if(!root) return;
        root.innerHTML = "";
        if(!allTasks.length){
          root.innerHTML = "<p class='muted'>No tasks yet. Upload your task Excel in your existing Officer panel (kept as-is).</p>";
          return;
        }
        allTasks.forEach((t,i) => { root.innerHTML += cardHTML(t,i); });
      }

      function renderAssigned(){
        const root = document.getElementById('assigned-list');
        if(!root) return;
        root.innerHTML = "";
        if(!currentUser){ root.innerHTML = "<p>Login first.</p>"; return; }
        const mine = allTasks.filter(t => t.assignedTo === currentUser.name && !t.done);
        if(!mine.length){ root.innerHTML = "<p>No assigned tasks.</p>"; return; }
        mine.forEach((t,i)=>{ root.innerHTML += cardHTML(t, allTasks.indexOf(t)); });
      }

      function renderDone(){
        const root = document.getElementById('done-list');
        if(!root) return;
        root.innerHTML = "";
        const done = allTasks.filter(t => t.done);
        if(!done.length){ root.innerHTML = "<p>No completed tasks yet.</p>"; return; }
        done.forEach((t,i)=>{ root.innerHTML += cardHTML(t, allTasks.indexOf(t)); });
      }

      // ====== Officer Actions ======
      function assign(i, name){
        if(!currentUser || currentUser.role!=="OFFICER"){ alert("Only officers can assign tasks."); return; }
        if(!allTasks[i]) return;

        // If roster exists, warn if off
        const isPresent = isPresentFromRoster(name);
        if(isPresent === false){
          alert(`${name} is off today based on the roster.`);
          // still allow or block? We’ll BLOCK to match your original intent:
          return;
        }

        allTasks[i].assignedTo = name || "";
        saveAppData();
        // Refresh views
        renderAllTasks();
        renderAssigned();
        renderProductivity();
      }

      function markDone(i, done){
        if(!allTasks[i]) return;
        // Guard: LAE & self-owned task & present
        if(!currentUser || currentUser.role!=="LAE"){ alert("Only LAEs can mark done."); return; }
        if(allTasks[i].assignedTo !== currentUser.name){ alert("This task is not assigned to you."); return; }
        const present = isPresentFromRoster(currentUser.name) ?? isPresentByFallback(currentUser.name);
        if(!present){ alert("You are not marked present today."); return; }

        allTasks[i].done = !!done;
        saveAppData();
        renderAllTasks();
        renderAssigned();
        renderDone();
        renderProductivity();
      }

      // ====== Productivity ======
      function renderProductivity(){
        const root = document.getElementById('productivity-data');
        if(!root) return;
        root.innerHTML = "";

        const perLAE = {};
        staffNames.forEach(n => perLAE[n] = { assigned:0, done:0 });

        allTasks.forEach(t => {
          if(t.assignedTo){
            perLAE[t.assignedTo] ??= {assigned:0, done:0};
            perLAE[t.assignedTo].assigned += 1;
            if(t.done) perLAE[t.assignedTo].done += 1;
          }
        });

        const rows = Object.entries(perLAE).map(([name, s]) => {
          const pct = s.assigned ? Math.round(s.done/s.assigned*100) : 0;
          return `<tr><td>${name}</td><td>${s.assigned}</td><td>${s.done}</td><td>${pct}%</td></tr>`;
        }).join("");

        root.innerHTML = `
          <table>
            <thead><tr><th>LAE</th><th>Tasks Assigned</th><th>Tasks Done</th><th>Productivity %</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      // ====== Attendance (Officer View) ======
      function renderAttendance(){
        const root = document.getElementById('attendance-data');
        if(!root) return;
        // Prefer roster-based attendance; fallback otherwise
        const lines = staffNames.map(n => {
          const rosterPresent = isPresentFromRoster(n);
          const present = rosterPresent ?? isPresentByFallback(n);
          return `<div>${n}: ${present ? "Present ✅" : "Off ❌"}</div>`;
        }).join("");
        root.innerHTML = lines + `<div style="margin-top:8px;"><small>Note: If roster not uploaded or today's column not found, fallback schedule is used.</small></div>`;
      }

      // ====== Roster Upload & Preview (Excel) ======
      function previewRoster(){
        const input = document.getElementById('roster-file');
        if(!input || !input.files || !input.files[0]){ alert("Please choose an .xlsx file."); return; }
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (evt) => {
          const data = new Uint8Array(evt.target.result);
          const wb = XLSX.read(data, { type:'array' });

          // Choose KUL sheet if present, otherwise first
          const targetSheetName = wb.SheetNames.includes("KUL") ? "KUL" : wb.SheetNames[0];
          const sheet = wb.Sheets[targetSheetName];
          rosterMatrix = XLSX.utils.sheet_to_json(sheet, { header:1, raw:true });

          // Save + parse header/name column
          saveAppData();
          detectHeaderAndNameColumn();
          // Show preview table immediately
          renderRosterPreviewTable();
          // Recompute attendance views
          renderAttendance();
        };
        reader.readAsArrayBuffer(file);
      }

      // ====== Roster Parsing Helpers (header row, name col, today's column) ======
      function isDayNumber(cell){
        if(cell == null) return false;
        if(typeof cell === 'number') return cell>=1 && cell<=31;
        const s = cell.toString().trim();
        if(!s) return false;
        const n = parseInt(s,10);
        return !isNaN(n) && n>=1 && n<=31;
      }

      function detectHeaderAndNameColumn(){
        if(!rosterMatrix.length){ rosterHeaderRow = -1; rosterNameCol = 0; return; }
        let bestRow = -1, bestCount = -1;
        for(let r=0; r<Math.min(rosterMatrix.length, 10); r++){
          const row = rosterMatrix[r] || [];
          const count = row.reduce((acc,cell)=> acc + (isDayNumber(cell)?1:0), 0);
          if(count>bestCount){ bestCount=count; bestRow=r; }
        }
        rosterHeaderRow = bestRow >= 0 ? bestRow : 0;

        let nameCol = 0;
        const headerCandidates = [rosterHeaderRow-1, rosterHeaderRow, rosterHeaderRow+1].filter(x=>x>=0);
        for(const hr of headerCandidates){
          const row = rosterMatrix[hr]||[];
          for(let c=0;c<row.length;c++){
            const v = (row[c]||"").toString().trim().toLowerCase();
            if(v==="name" || v==="employee" || v==="staff" || v==="lae"){
              nameCol = c; break;
            }
          }
        }
        rosterNameCol = nameCol;
      }

      function getTodayDayNumberMYT(){
        const nowMY = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kuala_Lumpur'}));
        return nowMY.getDate();
      }

      function findTodayColumnIndex(){
        if(rosterHeaderRow<0 || rosterMatrix.length===0) return -1;
        const header = rosterMatrix[rosterHeaderRow] || [];
        const d = getTodayDayNumberMYT();

        // exact number match
        for(let c=0;c<header.length;c++){
          if(typeof header[c]==='number' && header[c]===d) return c;
        }
        // string 'd'
        for(let c=0;c<header.length;c++){
          if((header[c]||"").toString().trim()===String(d)) return c;
        }
        // string '0d'
        for(let c=0;c<header.length;c++){
          if((header[c]||"").toString().trim()===String(d).padStart(2,'0')) return c;
        }
        return -1;
      }

      // Return true (present), false (off), or null (unknown) from roster
      function isPresentFromRoster(name){
        if(!rosterMatrix.length || rosterHeaderRow<0) return null;
        const col = findTodayColumnIndex();
        if(col<0) return null;

        for(let r=rosterHeaderRow+1; r<rosterMatrix.length; r++){
          const row = rosterMatrix[r]||[];
          const n = (row[rosterNameCol]||"").toString().trim();
          if(!n) continue;
          if(n.toLowerCase() === name.toLowerCase()){
            let code = row[col];
            if(code == null) code = "";
            code = code.toString().trim().toUpperCase();
            const offCodes = ['OFF','AL','SL','ML','EL','PH','MC','OFFDAY','OFF DAY','LEAVE','HOL','PHL','ANNUAL LEAVE','SICK LEAVE'];
            const isOff = (code==="" || offCodes.includes(code));
            return !isOff;
          }
        }
        return null;
      }

      // ====== Roster Preview (table) ======
      function renderRosterPreviewTable(){
        const el = document.getElementById('roster-preview');
        if(!el) return;
        if(!rosterMatrix.length){
          el.innerHTML = "<p>No roster loaded.</p>";
          return;
        }
        const maxRows = Math.min(rosterMatrix.length, 30);
        const maxCols = Math.min((rosterMatrix[0]||[]).length, 20);
        let html = '<div class=\"preview\"><table><thead><tr>';
        for(let c=0;c<maxCols;c++){
          const head = (rosterMatrix[rosterHeaderRow]||[])[c];
          html += `<th>${(head==null?'':head)}</th>`;
        }
        html += '</tr></thead><tbody>';
        for(let r=rosterHeaderRow+1; r<maxRows; r++){
          html += '<tr>';
          for(let c=0;c<maxCols;c++){
            const v = rosterMatrix[r] && rosterMatrix[r][c] != null ? rosterMatrix[r][c] : '';
            html += `<td>${v}</td>`;
          }
          html += '</tr>';
        }
        html += '</tbody></table></div>';
        el.innerHTML = html;
      }
      }
      return false;
    });

    // Save Tasks
    saveTasks();
    renderTasks();
    renderAssignedTasks();
    renderDoneTasks();
    updateDashboard();
  }

  // Attendance Section Toggle
  function toggleAttendance() {
    const section = document.getElementById("attendanceSection");
    section.classList.toggle("hidden");
    renderAttendance();
  }

  // Render Attendance (Officer View)
  function renderAttendance() {
    const user = JSON.parse(localStorage.getItem("currentUser"));
    if (user.role !== "officer") {
      document.getElementById("attendanceContent").innerHTML =
        "<p class='text-red-500'>Only officers can view attendance.</p>";
      return;
    }

    const laes = JSON.parse(localStorage.getItem("users")) || [];
    let html = `<table class="w-full border-collapse border border-gray-400 text-sm">
                  <tr class="bg-gray-200">
                    <th class="border border-gray-400 p-2">Name</th>
                    <th class="border border-gray-400 p-2">ID</th>
                    <th class="border border-gray-400 p-2">Attendance</th>
                  </tr>`;
    laes.forEach(u => {
      if (u.role === "lae") {
        html += `<tr>
                   <td class="border border-gray-400 p-2">${u.name}</td>
                   <td class="border border-gray-400 p-2">${u.id}</td>
                   <td class="border border-gray-400 p-2">Present</td>
                 </tr>`;
      }
    });
    html += "</table>";
    document.getElementById("attendanceContent").innerHTML = html;
  }

  // Render Roster Preview
  function renderRosterPreview() {
    const data = JSON.parse(localStorage.getItem("rosterData")) || [];
    let html = "<h3 class='font-semibold text-lg mb-2'>Uploaded Roster Preview</h3>";
    if (data.length === 0) {
      html += "<p class='text-gray-500'>No roster uploaded yet.</p>";
    } else {
      html += "<table class='w-full border border-gray-400 text-sm'>";
      data.forEach((row, i) => {
        html += `<tr class="${i === 0 ? 'bg-gray-300 font-bold' : 'bg-white'}">
                   ${row.map(cell => `<td class='border border-gray-400 p-2'>${cell}</td>`).join("")}
                 </tr>`;
      });
      html += "</table>";
    }
    document.getElementById("rosterPreviewContent").innerHTML = html;
  }

  // Roster Preview Toggle
  function toggleRosterPreview() {
    document.getElementById("rosterPreviewSection").classList.toggle("hidden");
    renderRosterPreview();
  }

  // Malaysia Time Clock
  function updateClock() {
    const options = { timeZone: "Asia/Kuala_Lumpur", hour: "2-digit", minute: "2-digit", second: "2-digit" };
    const now = new Date().toLocaleTimeString("en-GB", options);
    document.getElementById("clock").textContent = now;
  }
  setInterval(updateClock, 1000);

  // Initialize
  window.onload = () => {
    renderUsers();
    renderTasks();
    renderAssignedTasks();
    renderDoneTasks();
    updateDashboard();
    updateClock();
  };
</script>

</body>
</html>
