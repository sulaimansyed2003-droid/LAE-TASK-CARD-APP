<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Batik Air Task Card App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #800000; }
    .stats { margin-top: 20px; }
    .list { margin-top: 10px; }
    .list ul { list-style: none; padding: 0; }
    .list li { padding: 4px 0; }
    .upload { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Batik Air LAE Dashboard</h1>

  <div class="upload">
    <label>Upload Roster Excel: </label>
    <input type="file" id="fileInput" />
  </div>

  <div class="stats">
    <p><strong>Total LAEs:</strong> <span id="total"></span></p>
    <p><strong>Working Today:</strong> <span id="working"></span></p>
    <p><strong>Off Today:</strong> <span id="off"></span></p>
    <p><strong>Productivity %:</strong> <span id="productivity"></span></p>
  </div>

  <div class="list">
    <h3>✅ Working Today</h3>
    <ul id="workingList"></ul>
  </div>

  <div class="list">
    <h3>❌ Off Today</h3>
    <ul id="offList"></ul>
  </div>

  <canvas id="chart" width="400" height="200"></canvas>

  <script>
    document.getElementById('fileInput').addEventListener('change', handleFile, false);

    function handleFile(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        
        // pick "KUL" sheet
        const sheet = workbook.Sheets["KUL"];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        // find date column
        const today = new Date();
        const options = { day: 'numeric', month: 'long', year: '2-digit' };
        const todayStr = today.toLocaleDateString('en-GB', options).replace(',', '');
        // Excel format is like "18 August 25"
        let dateCol = -1;
        json[6].forEach((val, idx) => {
          if (val && val.toString().trim().toLowerCase() === todayStr.toLowerCase()) {
            dateCol = idx;
          }
        });

        if (dateCol === -1) {
          alert("Today's date not found in roster!");
          return;
        }

        let total = 0, working = 0, off = 0;
        let workingList = [], offList = [];

        for (let i = 7; i < json.length; i++) {
          const row = json[i];
          if (!row) continue;
          const name = row[5]; // column F = index 5
          if (!name) continue;
          total++;
          const duty = row[dateCol] ? row[dateCol].toString().trim() : "";
          if (duty === "" || duty.toUpperCase().includes("OFF") || duty.toUpperCase().includes("REST") || duty.toUpperCase().includes("AL")) {
            off++;
            offList.push(name);
          } else {
            working++;
            workingList.push(name + " (" + duty + ")");
          }
        }

        const productivity = total > 0 ? ((working / total) * 100).toFixed(2) : 0;

        document.getElementById("total").textContent = total;
        document.getElementById("working").textContent = working;
        document.getElementById("off").textContent = off;
        document.getElementById("productivity").textContent = productivity + "%";

        document.getElementById("workingList").innerHTML = workingList.map(n => `<li>${n}</li>`).join("");
        document.getElementById("offList").innerHTML = offList.map(n => `<li>${n}</li>`).join("");

        const ctx = document.getElementById('chart').getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Working', 'Off'],
            datasets: [{
              data: [working, off],
              backgroundColor: ['#800000', '#ccc']
            }]
          }
        });
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
