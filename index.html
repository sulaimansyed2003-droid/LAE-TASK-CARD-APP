<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LAE Task Card App (Officer & LAE)</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#8B1538">

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #8B1538;
      color: white;
      padding: 10px;
      text-align: center;
    }
    .container {
      padding: 15px;
    }
    .login-box {
      max-width: 400px;
      margin: auto;
      background: #f8f8f8;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    select, input, button {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .task-card {
      border: 2px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #fff;
    }
    .task-done {
      background-color: #d4edda !important;
    }
    .warning-yellow {
      border-color: #ffc107;
    }
    .warning-orange {
      border-color: #fd7e14;
    }
    .warning-red {
      border-color: #dc3545;
    }
    h2 {
      color: #8B1538;
    }
    .section-title {
      margin-top: 20px;
      padding: 8px;
      background: #eee;
      font-weight: bold;
      border-radius: 5px;
    }
    .filter-bar {
      position: sticky;
      top: 0;
      background: #f1f1f1;
      padding: 10px;
      z-index: 10;
      border-bottom: 1px solid #ccc;
    }
    .filter-bar input, .filter-bar select {
      display: inline-block;
      width: auto;
      min-width: 120px;
      margin-right: 10px;
    }
  </style>
</head>
<body>

<header>
  <h1>LAE Task Card App</h1>
  <div id="datetime"></div>
</header>

<div class="container" id="loginSection">
  <div class="login-box">
    <h2>Login</h2>
    <label for="nameSelect">Name</label>
    <select id="nameSelect"></select>
    <label for="staffId">Staff ID</label>
    <input type="text" id="staffId" placeholder="Enter Staff ID">
    <label for="roleSelect">Role</label>
    <select id="roleSelect">
      <option value="LAE">LAE</option>
      <option value="Officer">Officer</option>
    </select>
    <button onclick="login()">Sign In</button>
  </div>
</div>

<div class="container" id="officerSection" style="display:none;">
  <h2>Officer Panel</h2>
  <input type="file" id="excelFile" accept=".xlsx">
  <div class="filter-bar">
    <input type="text" id="searchOfficer" placeholder="Search tasks">
    <select id="ataFilterOfficer"></select>
  </div>
  <div id="officerTasks"></div>
</div>

<div class="container" id="laeSection" style="display:none;">
  <h2>LAE Panel</h2>
  <div id="taskCount"></div>

  <div class="section-title">My Tasks</div>
  <div class="filter-bar">
    <input type="text" id="searchMy" placeholder="Search my tasks">
    <select id="ataFilterMy"></select>
  </div>
  <div id="myTasks"></div>

  <div class="section-title">All Tasks</div>
  <div class="filter-bar">
    <input type="text" id="searchAll" placeholder="Search all tasks">
    <select id="ataFilterAll"></select>
  </div>
  <div id="allTasks"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
  const malaysianNames = [
    "Ahmad Faiz", "Nur Aisyah", "Muhammad Amir", "Siti Hajar", "Mohd Zulkifli",
    "Aina Sofea", "Hafizuddin", "Nurul Izzah", "Azlan Hakim", "Farah Nabila",
    "Syafiqah", "Mohamad Iqbal", "Siti Aminah", "Faris Zaim", "Nadia Farhana",
    "Iskandar Zulkarnain", "Amirah Syahirah", "Faizal Rahman", "Nur Syafiqa", "Hazim Hafiz",
    "Sabrina Amani", "Aiman Arif", "Husna Batrisyia", "Zaki Fikri", "Hannah Maisarah",
    "Mohd Ridzuan", "Liyana Sofiya", "Zulhilmi Firdaus", "Sarah Iman", "Ikmal Haziq",
    "Maisarah Humaira", "Naufal Danish", "Puteri Balqis", "Haris Azwan", "Alya Medina",
    "Akmal Hakim", "Siti Khadijah", "Aqil Haqim", "Nur Fatin", "Rayyan Harith",
    "Hafiza Qistina", "Adam Hakimi", "Sofia Qalesya", "Ahmad Danish", "Amalina Zahra",
    "Fahmi Ikhwan", "Qistina Syahirah", "Izzat Haziq", "Nur Aqeelah", "Hakim Zafran"
  ];

  let allTaskCards = [];
  let assignedTasks = {};
  let currentUser = null;
  let ataList = [];

  const nameSelect = document.getElementById("nameSelect");
  malaysianNames.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    nameSelect.appendChild(opt);
  });

  function login() {
    const name = nameSelect.value;
    const staffId = document.getElementById("staffId").value;
    const role = document.getElementById("roleSelect").value;
    currentUser = { name, staffId, role };
    document.getElementById("loginSection").style.display = "none";
    if (role === "Officer") {
      document.getElementById("officerSection").style.display = "block";
    } else {
      document.getElementById("laeSection").style.display = "block";
      renderLAEView();
    }
  }

  document.getElementById("excelFile").addEventListener("change", handleFile);
  function handleFile(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(evt) {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      allTaskCards = XLSX.utils.sheet_to_json(sheet);
      buildATAList();
      assignTasks();
      renderOfficerView();
      if (currentUser && currentUser.role === "LAE") {
        renderLAEView();
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function buildATAList() {
    const set = new Set(allTaskCards.map(t => t["ATA"]).filter(Boolean));
    ataList = ["All ATA", ...Array.from(set).sort()];
    ["ataFilterOfficer", "ataFilterMy", "ataFilterAll"].forEach(id => {
      const sel = document.getElementById(id);
      sel.innerHTML = "";
      ataList.forEach(ata => {
        const opt = document.createElement("option");
        opt.value = ata;
        opt.textContent = ata;
        sel.appendChild(opt);
      });
    });
  }

  function assignTasks() {
    assignedTasks = {};
    malaysianNames.forEach(name => assignedTasks[name] = []);
    allTaskCards.forEach(task => {
      const randomName = malaysianNames[Math.floor(Math.random() * malaysianNames.length)];
      assignedTasks[randomName].push(task);
    });
  }

  function renderOfficerView() {
    const container = document.getElementById("officerTasks");
    container.innerHTML = "";
    filterAndDisplay(allTaskCards, container, document.getElementById("searchOfficer").value, document.getElementById("ataFilterOfficer").value);
  }

  function renderLAEView() {
    const myTasksContainer = document.getElementById("myTasks");
    const allTasksContainer = document.getElementById("allTasks");
    myTasksContainer.innerHTML = "";
    allTasksContainer.innerHTML = "";

    const myTasks = assignedTasks[currentUser.name] || [];
    document.getElementById("taskCount").textContent = `My Tasks: ${myTasks.length}`;

    filterAndDisplay(myTasks.sort(sortByDueDate), myTasksContainer, document.getElementById("searchMy").value, document.getElementById("ataFilterMy").value);
    filterAndDisplay(allTaskCards, allTasksContainer, document.getElementById("searchAll").value, document.getElementById("ataFilterAll").value);
  }

  function filterAndDisplay(tasks, container, searchValue, ataValue) {
    const s = (searchValue || "").toLowerCase();
    const a = ataValue || "All ATA";
    tasks.filter(t => {
      const matchesSearch = Object.values(t).some(v => v && v.toString().toLowerCase().includes(s));
      const matchesATA = a === "All ATA" || t["ATA"] === a;
      return matchesSearch && matchesATA;
    }).forEach(task => {
      container.appendChild(createTaskCard(task));
    });
  }

  function createTaskCard(task) {
    const card = document.createElement("div");
    card.className = "task-card";
    let dueClass = "";
    if (task["DUE DATE"]) {
      const today = new Date();
      const dueDate = new Date(task["DUE DATE"]);
      const diffDays = Math.ceil((dueDate - today) / (1000*60*60*24));
      if (diffDays < 0) dueClass = "warning-red";
      else if (diffDays === 0) dueClass = "warning-orange";
      else if (diffDays <= 3) dueClass = "warning-yellow";
    }
    if (dueClass) card.classList.add(dueClass);
    card.innerHTML = `
      <strong>${task["TASK CARD NUM/ AMM REF"] || ""}</strong><br>
      ${task["TASK DESCRIPTION"] || ""}<br>
      <em>Tools:</em> ${task["TOOLS / TESTSET"] || ""}<br>
      <em>Consumables:</em> ${task["CONSUMABLES / MSL"] || ""}<br>
      <em>Remarks:</em> ${task["REMARKS"] || ""}<br>
      <em>Duration:</em> ${task["DURATION"] || ""}<br>
      <em>Man Hours:</em> ${task["MANHOURS NEEDED"] || ""}<br>
      <em>Due Date:</em> ${task["DUE DATE"] || ""}<br>
      <label><input type="checkbox" onchange="markDone(this)"> Done</label>
    `;
    return card;
  }

  function markDone(checkbox) {
    if (checkbox.checked) {
      checkbox.closest(".task-card").classList.add("task-done");
    } else {
      checkbox.closest(".task-card").classList.remove("task-done");
    }
  }

  function sortByDueDate(a, b) {
    const ad = new Date(a["DUE DATE"] || "2100-01-01");
    const bd = new Date(b["DUE DATE"] || "2100-01-01");
    return ad - bd;
  }

  ["searchOfficer","ataFilterOfficer"].forEach(id => document.getElementById(id).addEventListener("input", renderOfficerView));
  ["searchMy","ataFilterMy","searchAll","ataFilterAll"].forEach(id => document.getElementById(id).addEventListener("input", renderLAEView));

  setInterval(() => {
    const now = new Date();
    document.getElementById("datetime").textContent =
      now.toLocaleDateString("en-MY", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) +
      " " + now.toLocaleTimeString();
  }, 1000);
</script>

</body>
</html>
