<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Batik Air Task Card App</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    header { background:#800000; color:white; padding:10px; text-align:center; }
    .login-box { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
    .login-box input, .login-box select, .login-box button { margin:5px; padding:8px; font-size:16px; }
    .hidden { display:none; }
    .container { padding:20px; }
    .task-card { background:white; margin:10px 0; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
    .task-card.done { background:#d4edda; }
    .task-header { font-size:18px; font-weight:bold; margin-bottom:10px; color:#800000; }
    .block { margin:5px 0; padding:6px; border-left:4px solid #80000022; background:#fafafa; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; }
    .meta-pill { background:#eee; padding:5px 10px; border-radius:12px; font-size:14px; }
    .task-actions { margin-top:10px; }
    .assigned-bold { font-weight:bold; color:#800000; }
    nav button { margin:5px; padding:8px 12px; border:none; border-radius:5px; background:#800000; color:white; cursor:pointer; }
    nav button:hover { background:#a00000; }
    #allDoneMsg { text-align:center; font-size:18px; font-weight:bold; color:green; margin:20px 0; }
  </style>
</head>
<body>
  <header><h1>Batik Air Task Card System</h1></header>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="login-box">
    <h2>Login</h2>
    <input type="text" id="idInput" placeholder="Enter your ID">
    <select id="nameInput"></select>
    <select id="roleInput">
      <option value="">Select Role</option>
      <option value="OFFICER">Officer</option>
      <option value="LAE">LAE</option>
    </select>
    <button onclick="login()">Sign In</button>
    <div id="loginTime"></div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden">
    <nav>
      <button onclick="showSection('allTasks')">All Tasks</button>
      <button onclick="showSection('assignedTasks')">Assigned Tasks</button>
      <button onclick="showSection('doneTasks')">Done</button>
      <button onclick="signOut()">Sign Out</button>
    </nav>

    <div id="officerSection" class="hidden">
      <h2>Officer Panel</h2>
      <input type="file" id="fileInput" accept=".xlsx" onchange="handleFile(event)">
    </div>

    <div class="container">
      <div id="ataFilter"></div>
      <div id="allTasks"></div>
      <div id="assignedTasks" class="hidden"></div>
      <div id="doneTasks" class="hidden"></div>
      <div id="allDoneMsg" class="hidden">ðŸŽ‰ All assigned tasks are done for now!</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let staffNames = [
      "ABDUL FATAH BIN IBRAHIM","MOHD HAFIZ SAZWAN BIN ZAM ZAM","MOHAMMAD ZULKIFLEE BIN HUSSIN",
      "DING JU SHENG","LEE YOONG JUN","MUHAMMAD NAZIF BIN ABDUL MALEK"
      // ... add the rest of your ~400 names here
    ];

    let allTasks = [];
    let currentUser = null;

    function populateNames(){
      const sel=document.getElementById("nameInput");
      sel.innerHTML='<option value="">Select your name</option>';
      staffNames.forEach(n=>{let o=document.createElement("option");o.value=n;o.textContent=n;sel.appendChild(o)});
    }
    populateNames();

    function login(){
      const id=document.getElementById("idInput").value;
      const name=document.getElementById("nameInput").value;
      const role=document.getElementById("roleInput").value;
      if(!id||!name||!role){alert("Fill all fields");return;}
      currentUser={id,name,role};
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      if(role==="OFFICER"){ document.getElementById("officerSection").classList.remove("hidden"); }
      else{ document.getElementById("officerSection").classList.add("hidden"); }
      updateLoginTime();
    }

    function updateLoginTime(){
      const now=new Date();
      document.getElementById("loginTime").innerText = "Login Time: "+ now.toLocaleString();
    }

    function signOut(){
      currentUser=null;
      document.getElementById("app").classList.add("hidden");
      document.getElementById("loginPage").classList.remove("hidden");
      document.getElementById("allDoneMsg").classList.add("hidden");
    }

    function handleFile(e){
      const file=e.target.files[0];
      const reader=new FileReader();
      reader.onload=function(evt){
        const data=new Uint8Array(evt.target.result);
        const workbook=XLSX.read(data,{type:'array'});
        const sheet=workbook.Sheets[workbook.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(sheet);
        allTasks=json.map(r=>({
          ata:r["ATA"]||"",   // âœ… include ATA number
          card:r["TASK CARD NUM/ AMM REF"]||"",
          description:r["TASK DESCRIPTION"]||"",
          tools:r["TOOLS / TESTSET"]||"",
          consumables:r["CONSUMABLES / MSL"]||"",
          remarks:r["REMARKS"]||"",
          manhour:r["DURATION MANHOUR"]||"",
          due:r["DUE"]||"",
          assignedTo:"",
          done:false
        }));
        renderTasks();
      };
      reader.readAsArrayBuffer(file);
    }

    function showSection(id){
      document.querySelectorAll(".container > div").forEach(d=>d.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      document.getElementById("allDoneMsg").classList.add("hidden"); // hide by default
      renderTasks();
    }

    function renderTasks(){
      let ataFilter=document.getElementById("ataSelect")?.value||"ALL";
      let filterFn=t=>(ataFilter==="ALL"||t.ata==ataFilter);
      let sections={allTasks:[], assignedTasks:[], doneTasks:[]};

      allTasks.forEach((t,i)=>{
        if(filterFn(t)){
          if(t.done){sections.doneTasks.push([t,i]);}
          else{
            sections.allTasks.push([t,i]);
            if(t.assignedTo===currentUser?.name){sections.assignedTasks.push([t,i]);}
          }
        }
      });

      // check if all assigned tasks are done
      if(currentUser?.role==="LAE"){
        const userAssigned=allTasks.filter(t=>t.assignedTo===currentUser.name);
        const userDone=userAssigned.filter(t=>t.done);
        if(userAssigned.length>0 && userAssigned.length===userDone.length){
          document.getElementById("allDoneMsg").classList.remove("hidden");
        }
      }

      for(let sec in sections){
        let cont=document.getElementById(sec);
        cont.innerHTML="";
        sections[sec].forEach(([t,i])=>{
          let canMark=(currentUser.role==="LAE" && t.assignedTo===currentUser.name);
          let card=document.createElement("div");
          card.className="task-card"+(t.done?" done":"");
          card.innerHTML=`
            <div class="task-header">ATA ${t.ata}</div>
            <div class="block"><b>Task Card Num / AMM Ref:</b> ${t.card}</div>
            <div class="block"><b>Task Description:</b> ${t.description}</div>
            <div class="block"><b>Tools / Testset:</b> ${t.tools}</div>
            <div class="block"><b>Consumables / MSL:</b> ${t.consumables}</div>
            <div class="block"><b>Remarks:</b> ${t.remarks}</div>
            <div class="row">
              <div class="meta-pill">Duration / Manhour: ${t.manhour||"N/A"}</div>
              <div class="meta-pill">Due: ${t.due||"N/A"}</div>
              <div class="meta-pill">Assigned To: <span class="${t.assignedTo?'assigned-bold':''}">${t.assignedTo||"None"}</span></div>
            </div>
            <div class="task-actions">
              ${ currentUser?.role==="OFFICER"
                ? `Assign:
                    <select onchange="assign(${i}, this.value)">
                      <option value="">Assign to...</option>
                      ${staffNames.map(n=>`<option value="${n}" ${t.assignedTo===n?'selected':''}>${n}</option>`).join("")}
                    </select>` : `` }
              ${ canMark
                ? `<label><input type="checkbox" ${t.done?"checked":""}
                      onchange="markDone(${i}, this.checked)"> Mark Done</label>` : `` }
            </div>`;
          cont.appendChild(card);
        });
      }
      populateATAFilter();
    }

    function assign(i,name){ allTasks[i].assignedTo=name; renderTasks(); }
    function markDone(i,done){ allTasks[i].done=done; renderTasks(); }

    function populateATAFilter(){
      if(document.getElementById("ataSelect")) return;
      let div=document.getElementById("ataFilter");
      let sel=document.createElement("select");
      sel.id="ataSelect";
      sel.innerHTML='<option value="ALL">All ATA</option>';
      for(let n=1;n<=40;n++){sel.innerHTML+=`<option value="${n}">ATA ${n}</option>`;}
      sel.onchange=()=>renderTasks();
      div.appendChild(sel);
    }
  </script>
</body>
</html>
