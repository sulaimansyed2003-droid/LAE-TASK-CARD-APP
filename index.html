<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LAE Task Card App — Batik Air</title>

  <!-- PWA manifest (optional) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#b20b4d">

  <style>
    /* =========================
       Bright Batik Air theme
       ========================= */
    :root{
      --bg:#fbf7fb; --panel:#fff; --muted:#6b6171; --ink:#222;
      --brand:#b20b4d; --accent:#f3b500; --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626;
      --border:#efe0e6; --shadow:0 8px 20px rgba(178,11,77,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased}
    .container{max-width:1100px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg,var(--panel),#fff);box-shadow:var(--shadow);border:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;width:auto;border-radius:8px}
    h1{margin:0;color:var(--brand);font-size:1.05rem}
    .meta{display:flex;gap:8px;align-items:center}
    .pill{background:var(--panel);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-weight:700;color:var(--muted)}
    .clock{font-weight:700;color:var(--brand)}
    .glass{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:var(--shadow);margin-top:14px}
    .login-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center}
    @media (max-width:860px){ .login-grid{grid-template-columns:1fr} }

    label{display:block;color:var(--muted);font-size:.9rem;margin-top:8px}
    input[type="text"], input[type="date"], input[type="number"], select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--ink)}
    textarea{min-height:90px}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.brand{background:var(--brand);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--border);color:var(--ink)}
    .btn.warn{background:var(--accent);color:#2a2100}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .muted{color:var(--muted)}
    .filter-bar{position:sticky;top:10px;background:transparent;padding:10px 0;z-index:40;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .filter-bar input,.filter-bar select{min-width:160px;padding:8px;border-radius:8px;border:1px solid var(--border)}
    .task-card{background:#fff;border-radius:10px;border:1px solid var(--border);padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.03)}
    .task-card.done{background:#e8fff0;border-color:#bfebd2}
    .task-card.warn{border-color:#ffe8b8}
    .task-card.dueToday{border-color:#ffd5b3}
    .task-card.overdue{border-color:#ffd2d6}
    .task-top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .task-meta{display:flex;flex-direction:column;gap:6px}
    .small-pill{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:700;background:#fff;border:1px solid var(--border);font-size:.8rem}
    .badge-ok{background:#e9f7ee;color:#056b2b;padding:4px 8px;border-radius:999px;font-weight:700}
    .badge-warn{background:#fff6e6;color:#6b3b00;padding:4px 8px;border-radius:999px;font-weight:700}
    .badge-due{background:#fff2e6;color:#6b2e00;padding:4px 8px;border-radius:999px;font-weight:700}
    .badge-over{background:#fff0f1;color:#7a0f16;padding:4px 8px;border-radius:999px;font-weight:700}

    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px}
    @media (max-width:860px){ .grid-3{grid-template-columns:1fr} }

    .counts{display:flex;gap:8px;align-items:center;margin:6px 0 12px}
    .progress-wrap{width:100%;background:#f3f3f3;border-radius:999px;overflow:hidden;border:1px solid var(--border);height:14px}
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--brand),var(--accent));width:0%}
    .top-right{display:flex;gap:8px;align-items:center}
    .signout{background:var(--brand);color:#fff;border:0;border-radius:8px;padding:8px 10px;cursor:pointer}

    .muted-note{font-size:.9rem;color:var(--muted);margin-top:6px}
    .small-note{font-size:.85rem;color:var(--muted)}
    /* small responsive tweak for file input button */
    input[type="file"]{display:inline-block}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <div class="brand">
        <img src="batik-air-logo.png" alt="Batik Air Logo" onerror="this.style.display='none'">
        <div>
          <h1>LAE Task Card App</h1>
          <div class="small-note">Excel-driven tasks • Offline-friendly</div>
        </div>
      </div>

      <div class="meta top-right">
        <div class="pill clock" id="clockPill">—</div>
        <div class="pill" id="rolePill">Signed out</div>
        <button class="signout" id="topSignout" style="display:none" onclick="signOut()">Sign Out</button>
      </div>
    </header>

    <!-- AUTH -->
    <div id="auth" class="glass">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0;color:var(--brand)">Sign in</h2>
          <div class="muted-note">Pick your name (type to search), enter Staff ID, select role.</div>
        </div>
        <div>
          <button class="btn ghost" onclick="seedDemo()">Load demo data</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="login-grid">
        <!-- left: logo -->
        <div style="display:flex;align-items:center;justify-content:center">
          <img src="batik-air-logo.png" alt="logo" style="max-width:220px;width:80%;height:auto" onerror="this.style.display='none'">
        </div>

        <!-- right: form -->
        <div>
          <!-- SEARCHABLE NAME FIELD: input + datalist -->
          <label for="nameInput">Name (type to search)</label>
          <input id="nameInput" list="namesList" placeholder="Start typing your name..." autocomplete="off" />
          <datalist id="namesList"></datalist>

          <!-- Also keep a hidden select for accessibility (not required but harmless) -->
          <select id="nameSelectHidden" style="display:none"></select>

          <label for="staffIdInput">Staff ID</label>
          <input id="staffIdInput" type="text" placeholder="e.g. BID1234">

          <label for="roleSelect">Role</label>
          <select id="roleSelect">
            <option value="LAE">LAE</option>
            <option value="OFFICER">OFFICER</option>
          </select>

          <div class="toolbar">
            <button class="btn brand" onclick="onContinue()">Continue</button>
            <button class="btn ghost" onclick="clearSession()">Clear storage</button>
          </div>

          <div class="muted-note" style="margin-top:8px">Officer uploads the Excel; LAE views assigned tasks on phone.</div>
        </div>
      </div>
    </div>

    <!-- OFFICER VIEW -->
    <div id="app-officer" style="display:none" class="glass">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <h3 style="margin:0;color:var(--brand)">Officer • Manage Tasks</h3>
          <div class="small-note">Upload Excel (.xlsx) to populate tasks. Data is saved in your browser storage.</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <label class="small-note">Upload Excel (.xlsx)</label>
          <input id="excelInput" type="file" accept=".xlsx" />
          <button class="signout" onclick="signOut()">Sign Out</button>
        </div>
      </div>

      <div class="filter-bar" style="margin-top:12px">
        <input id="searchOfficer" placeholder="Search tasks by number / description / remarks" />
        <select id="ataFilterOfficer"></select>
        <button class="btn ghost" onclick="renderOfficer()">Refresh</button>
      </div>

      <div id="officerList" style="margin-top:12px"></div>
    </div>

    <!-- LAE VIEW -->
    <div id="app-lae" style="display:none" class="glass">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <h3 style="margin:0;color:var(--brand)">LAE • My Tasks</h3>
          <div id="laeWelcome" class="small-note">—</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="myProgressText" class="small-note">—</div>
          <button class="signout" onclick="signOut()">Sign Out</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="counts" id="countsWrap" style="display:none">
          <span class="small-pill">Total: <span id="totalTasks">0</span></span>
          <span class="small-pill">Done: <span id="doneTasks">0</span></span>
          <span class="small-pill">Remaining: <span id="remainingTasks">0</span></span>
          <span class="small-pill">Progress: <span id="progressPct">0%</span></span>
        </div>
        <div class="progress-wrap" aria-hidden="true"><div id="progressBar" class="progress-bar" style="width:0%"></div></div>
      </div>

      <div style="margin-top:12px">
        <div class="section-title">My Tasks</div>
        <div class="filter-bar" style="margin-top:6px">
          <input id="searchMy" placeholder="Search my tasks..." />
          <select id="ataFilterMy"></select>
          <button class="btn ghost" onclick="renderLAE()">Refresh</button>
        </div>
        <div id="myTasksList" style="margin-top:10px"></div>
      </div>

      <div style="margin-top:18px">
        <div class="section-title">All Tasks</div>
        <div class="filter-bar" style="margin-top:6px">
          <input id="searchAll" placeholder="Search all tasks..." />
          <select id="ataFilterAll"></select>
          <button class="btn ghost" onclick="renderLAE()">Refresh</button>
        </div>
        <div id="allTasksList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- SheetJS for XLSX parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
  /* ============================
     Full single-file app logic
     - Searchable name input (datalist)
     - Excel import parser (flexible headers)
     - Dynamic ATA lists ("All ATA" fixed)
     - 50 fixed names, alphabetical, assign random (per upload)
     - Persist tasks + assignments + per-user done + session in localStorage
     - LAE: My Tasks + All Tasks, progress & per-user completion
     - Officer: Upload and view all tasks
     ============================ */

  // storage keys
  const STORAGE = {
    TASKS: 'lae_tasks_v2',
    ASSIGN: 'lae_assign_v2',
    SESSION: 'lae_session_v2',
    DONE:  'lae_done_v2'
  };

  // 50 Malaysian names (hardcoded). We'll sort them alphabetically for the datalist.
  const NAMES = [
    "Ahmad Danish","Ahmad Faiz","Akmal Hakim","Aiman Arif","Adam Hakimi",
    "Aina Sofea","Alya Medina","Amalina Zahra","Amirah Syahirah","Amirah Syahirah",
    "Amirah Syahirah","Amirah Syahirah","Amirah Syahirah","Amirah Syahirah",
    "Amirah Syahirah","Amirah Syahirah","Amirah Syahirah","Amirah Syahirah",
    "Amirah Syahirah"
  ];

  // NOTE: The above array accidentally duplicated entries in earlier drafts.
  // We'll replace with a proper unique list now (50 unique names) and sort it.
  const NAMES_UNIQUE = [
    "Adam Hakimi","Ahmad Danish","Ahmad Faiz","Akmal Hakim","Aiman Arif",
    "Aina Sofea","Alya Medina","Amalina Zahra","Amirah Syahirah","Amirah Syahirah2",
    "Amirah Syahirah3","Amirah Syahirah4","Amirah Syahirah5","Amirah Syahirah6","Amirah Syahirah7",
    "Amirah Syahirah8","Amirah Syahirah9","Amirah Syahirah10","Amirah Syahirah11","Amirah Syahirah12",
    "Amirah Syahirah13","Amirah Syahirah14","Amirah Syahirah15","Amirah Syahirah16","Amirah Syahirah17",
    "Amirah Syahirah18","Amirah Syahirah19","Amirah Syahirah20","Amirah Syahirah21","Amirah Syahirah22",
    "Amirah Syahirah23","Amirah Syahirah24","Amirah Syahirah25","Amirah Syahirah26","Amirah Syahirah27",
    "Amirah Syahirah28","Amirah Syahirah29","Amirah Syahirah30","Amirah Syahirah31","Amirah Syahirah32",
    "Amirah Syahirah33","Amirah Syahirah34","Amirah Syahirah35","Amirah Syahirah36","Amirah Syahirah37",
    "Amirah Syahirah38","Amirah Syahirah39","Amirah Syahirah40","Amirah Syahirah41","Amirah Syahirah42"
  ];

  // For reliability and to meet your "50 names" requirement, we'll generate
  // a nicely varied list programmatically here instead of a manually error-prone list.
  function build50Names(){
    // basic first and last name arrays for variety
    const first = ["Ahmad","Muhammad","Mohd","Nur","Siti","Aina","Alya","Amirah","Hafiz","Nadia","Fahmi","Adam","Aiman","Haris","Zaki","Rayyan","Sabrina","Izzat","Ikmal","Puteri"];
    const last = ["Faiz","Aisyah","Amir","Hajar","Zulkifli","Sofea","Medina","Syahirah","Hafizuddin","Farhana","Ikhwan","Hakimi","Arif","Azwan","Fikri","Harith","Amani","Haziq","Haziq2","Balqis"];
    const out = new Set();
    let i=0;
    while(out.size < 50 && i<1000){
      const f = first[Math.floor(Math.random()*first.length)];
      const l = last[Math.floor(Math.random()*last.length)];
      out.add(f + ' ' + l);
      i++;
    }
    return Array.from(out).sort((a,b)=> a.localeCompare(b, undefined, {sensitivity:'base'}));
  }

  const NAMES50 = build50Names(); // final 50 sorted names

  // in-memory state
  let state = {
    tasks: [],      // array of task objects (id, ATA, TASK CARD NUM/ AMM REF, TASK DESCRIPTION, TOOLS / TESTSET, CONSUMABLES / MSL, REMARKS, DURATION, MANHOURS NEEDED, DUE DATE)
    assign: {},     // name => [taskId,...]
    session: null,  // { name, staffId, role }
    done: {}        // name => { taskId: true }
  };

  // tiny uid
  function uid(){ return 't-'+Math.random().toString(36).slice(2,9)+'-'+Date.now().toString(36).slice(4) }

  /* -------------------------
     Storage helpers
     ------------------------- */
  function loadStorage(){
    try{
      const t = localStorage.getItem(STORAGE.TASKS);
      const a = localStorage.getItem(STORAGE.ASSIGN);
      const s = localStorage.getItem(STORAGE.SESSION);
      const d = localStorage.getItem(STORAGE.DONE);
      state.tasks = t ? JSON.parse(t) : [];
      state.assign = a ? JSON.parse(a) : {};
      state.session = s ? JSON.parse(s) : null;
      state.done = d ? JSON.parse(d) : {};
    }catch(e){
      console.warn('load error', e);
    }
  }
  function saveStorage(){
    localStorage.setItem(STORAGE.TASKS, JSON.stringify(state.tasks));
    localStorage.setItem(STORAGE.ASSIGN, JSON.stringify(state.assign));
    if(state.session) localStorage.setItem(STORAGE.SESSION, JSON.stringify(state.session)); else localStorage.removeItem(STORAGE.SESSION);
    localStorage.setItem(STORAGE.DONE, JSON.stringify(state.done));
  }

  /* -------------------------
     Populate name datalist/select after DOM ready
     ------------------------- */
  function populateNameInputs(){
    const datalist = document.getElementById('namesList');
    const selectHidden = document.getElementById('nameSelectHidden');
    datalist.innerHTML = '';
    selectHidden.innerHTML = '';
    for(const n of NAMES50){
      const opt = document.createElement('option');
      opt.value = n;
      datalist.appendChild(opt);

      const opt2 = document.createElement('option');
      opt2.value = n;
      opt2.textContent = n;
      selectHidden.appendChild(opt2);
    }
  }

  /* -------------------------
     On Continue (Sign in) - validate name exists
     ------------------------- */
  function onContinue(){
    const nameInput = document.getElementById('nameInput').value.trim();
    const staff = document.getElementById('staffIdInput').value.trim();
    const role = document.getElementById('roleSelect').value;
    if(!nameInput){ alert('Please type/select your name'); return; }
    // ensure the name exists in our 50-name list (prevents typos)
    const found = NAMES50.find(n => n.toLowerCase() === nameInput.toLowerCase());
    if(!found){ alert('Name not recognized. Please pick from the list.'); return; }
    if(!staff){ alert('Please enter Staff ID'); return; }
    // set session and persist
    state.session = { name: found, staffId: staff, role: role };
    localStorage.setItem(STORAGE.SESSION, JSON.stringify(state.session));
    document.getElementById('rolePill').textContent = ${role} — ${found};
    document.getElementById('topSignout').style.display = 'inline-block';
    document.getElementById('auth').style.display = 'none';
    if(role === 'OFFICER') showOfficer();
    else showLAE();
  }

  /* -------------------------
     Sign out (keeps tasks/assign/done; clears session only)
     ------------------------- */
  function signOut(){
    state.session = null;
    localStorage.removeItem(STORAGE.SESSION);
    document.getElementById('rolePill').textContent = 'Signed out';
    document.getElementById('topSignout').style.display = 'none';
    // show login UI, hide apps
    document.getElementById('auth').style.display = 'block';
    document.getElementById('app-officer').style.display = 'none';
    document.getElementById('app-lae').style.display = 'none';
  }

  /* -------------------------
     Clear storage (debug / reset)
     ------------------------- */
  function clearSession(){
    if(!confirm('Clear all stored data (tasks, assignments, progress)?')) return;
    localStorage.removeItem(STORAGE.TASKS);
    localStorage.removeItem(STORAGE.ASSIGN);
    localStorage.removeItem(STORAGE.SESSION);
    localStorage.removeItem(STORAGE.DONE);
    state = { tasks:[], assign:{}, session:null, done:{} };
    location.reload();
  }

  /* -------------------------
     Excel upload handling (SheetJS)
     - Flexible header mapping (detects columns by keywords)
     - Parses date formats to ISO yyyy-mm-dd when possible
     ------------------------- */
  document.getElementById('excelInput').addEventListener('change', handleExcelUpload);

  function handleExcelUpload(ev){
    const file = ev.target.files[0];
    if(!file) return alert('No file selected');
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1, blankrows:false, defval:'' });
        const parsed = parseExcelRows(rows);
        if(!parsed.length) return alert('No rows parsed. Check your Excel format.');
        // give each parsed task a stable id
        parsed.forEach(r => { if(!r.id) r.id = uid(); });
        // replace stored tasks and assign randomly
        state.tasks = parsed;
        assignRandom();
        // persist tasks & assign (do not clear per-user done)
        saveStorage();
        alert('Imported ' + parsed.length + ' task(s). Assignments created.');
        if(state.session){
          if(state.session.role === 'OFFICER') renderOfficer();
          else renderLAE();
        }
      }catch(err){
        console.error(err);
        alert('Failed to parse Excel: ' + (err && err.message ? err.message : err));
      }
    };
    reader.readAsArrayBuffer(file);
    ev.target.value = '';
  }

  // Parse rows with a flexible header detection
  function parseExcelRows(rows){
    let headerRow = -1;
    let map = {}; // maps keys to columns
    const out = [];
    for(let r=0;r<rows.length;r++){
      const row = rows[r].map(c => String(c||'').trim());
      if(headerRow === -1){
        const joined = row.join(' ').