<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Batik Air Task Card App</title>


  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; color:#222; }
    header { background:#800000; color:white; padding:14px; text-align:center; position:relative; }
    .login-box { display:flex; flex-direction:column; align-items:center; justify-content:center; height:70vh; gap:8px; }
    .login-box input, .login-box select, .login-box button { margin:5px; padding:8px; font-size:16px; min-width:220px; }
    .hidden { display:none !important; }
    .container { padding:20px; max-width:1200px; margin:0 auto; }
    .task-card { background:white; margin:10px 0; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.08); }
    .task-card.done { background:#d4edda; }
    .task-header { font-size:16px; font-weight:700; margin-bottom:8px; color:#800000; }
    .block { margin:6px 0; padding:6px; border-left:4px solid rgba(128,0,0,0.14); background:#fafafa; border-radius:4px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:center; }
    .meta-pill { background:#eee; padding:6px 10px; border-radius:12px; font-size:13px; }
    .task-actions { margin-top:10px; }
    .assigned-bold { font-weight:bold; color:#800000; }
    nav button { margin:5px; padding:8px 12px; border:none; border-radius:5px; background:#800000; color:white; cursor:pointer; }
    nav button:hover { background:#a00000; } nav button.active {
  background: #007bff !important; /* blue */
  color: white !important;
}
    #allDoneMsg { text-align:center; font-size:18px; font-weight:bold; color:green; margin:20px 0; }
    #assignedOverview { background:#fff3f3; padding:10px; border-radius:8px; margin:15px 0; }
    #userInfo { background:#fff3f3; padding:10px; border-radius:8px; margin:10px 0; font-weight:bold; color:#800000; }
    .btn-toggle { margin:5px 0; padding:6px 10px; background:#800000; color:white; border:none; border-radius:5px; cursor:pointer; }
    .btn-toggle:hover { background:#a00000; }
    #prodDash { background:#ffffff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.06); padding:16px; margin-top:8px; }
    .prod-row { display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
    .prod-card { flex:1; min-width:240px; background:#fafafa; border-left:4px solid rgba(128,0,0,0.14); border-radius:8px; padding:12px; }
    .name-item { padding:6px 8px; background:#fff; border:1px solid #eee; border-radius:8px; margin:6px 0; }
    .table-wrap { max-height:320px; overflow:auto; border:1px solid #eee; border-radius:8px; background:#fff; padding:8px; }
    table.preview { width:100%; border-collapse:collapse; }
    table.preview th, table.preview td { border:1px solid #eee; padding:6px; font-size:12px; }
    .muted { color:#666; font-size:12px; }

    /* Attendance table styles */
    .attendance-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    .attendance-table th, .attendance-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    .attendance-table th { background-color: #800000; color: white; }
    .attendance-table tr:nth-child(even) { background-color: #f9f9f9; }
    .attendance-table tr:hover { background-color: #f1f1f1; }
    .status-present { color: green; font-weight: bold; }
    .status-absent { color: red; font-weight: bold; }
    .status-off { color: #666; font-style: italic; }
    .attendance-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
    .attendance-summary { background: #fff3f3; padding: 10px; border-radius: 8px; margin: 15px 0; }

    /* Mobile menu */
    .mobile-menu-btn { position: absolute; right: 10px; top: 10px; background: none; border: none; color: white; font-size: 24px; cursor: pointer; display:none; }
    .mobile-menu { position: fixed; top: 60px; right: 10px; background: white; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; display: none; flex-direction: column; min-width: 200px; }
    .mobile-menu.show { display:flex; }
    .mobile-menu button { padding: 10px 15px; border: none; background: none; text-align: left; cursor: pointer; }
    .mobile-menu .sign-out { border-top: 1px solid #eee; color: #800000; font-weight: bold; }

    /* Dark mode */
    body.dark-mode { background:#121212; color:#f5f5f5; }
    body.dark-mode .task-card { background:#1e1e1e; border-left:4px solid #ff4444; }
    body.dark-mode .task-card.done { background:#2e7d32; }
    body.dark-mode header { background:#222; color:#fff; }
    body.dark-mode nav button, body.dark-mode .btn-toggle { background:#333; color:#fff; }
    body.dark-mode .btn-toggle:hover { background:#555; }
    body.dark-mode #assignedOverview, body.dark-mode #userInfo, body.dark-mode #productivityDashboard, body.dark-mode #prodDash { background:#1a1a1a; color:#fff; }
    body.dark-mode table, body.dark-mode th, body.dark-mode td { border-color:#555; color:#fff; }
    body.dark-mode .attendance-table th { background-color: #600000; }
    body.dark-mode .attendance-table tr:nth-child(even) { background-color: #2a2a2a; }
    body.dark-mode .attendance-table tr:hover { background-color: #333; }
    body.dark-mode .attendance-summary { background: #2a1a1a; }

    /* NEW STYLES FOR OFFICER APPROVAL SYSTEM */
    .approval-section { margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px; border-left: 4px solid #3498db; }
    .approval-status { font-weight: bold; margin-bottom: 8px; }
    .status-pending { color: #e74c3c; }
    .status-submitted { color: #f39c12; }
    .status-verified { color: #2ecc71; }
    .btn-approve { background: #2ecc71; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px; }
    .btn-reject { background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    .approval-history { margin-top: 10px; font-size: 12px; color: #666; }
    .approval-history div { margin-bottom: 4px; }

    /* ðŸ”¹ Make fonts bigger everywhere */
    body, input, select, button, table, .task-card, #clock {
      font-size: 18px !important;
    }
    header h1 { font-size: 26px !important; }
    .task-header { font-size: 20px !important; }
    .meta-pill { font-size: 15px !important; }


    @media (max-width: 768px) {
      .mobile-menu-btn { display: block; }
      nav { display: none; }
      .attendance-table { font-size: 14px; }
      .attendance-table th, .attendance-table td { padding: 6px; }
      .approval-section { padding: 8px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Batik Air Task Card System</h1>
  </header>

  <!-- LOGIN -->
  <div id="loginPage" class="login-box">
    <h2>Sign In</h2>
    <input type="text" id="idInput" placeholder="Enter your ID (e.g., 12345)" />
    <select id="nameInput"><option value="">Loading names...</option></select>
    <select id="roleInput">
      <option value="">Select Role</option>
      <option value="OFFICER">Officer</option>
      <option value="LAE">LAE</option>
    </select>
    <button id="signInBtn">Sign In</button>
    <div id="loginTime"></div>
  </div>


  <!-- Mobile menu -->
  <div id="mobileMenu" class="mobile-menu">
    <button onclick="showSection('allTasks'); hideMobileMenu()">All Tasks</button>
    <button onclick="showSection('assignedTasks'); hideMobileMenu()">Assigned Tasks</button>
    <button onclick="showSection('doneTasks'); hideMobileMenu()">Done</button>
    <button onclick="showSection('prodDash'); hideMobileMenu()">Productivity Dashboard</button>
    <button onclick="showSection('attendanceSection'); hideMobileMenu()">Attendance</button>
    <button class="sign-out" onclick="signOut(); hideMobileMenu()">Sign Out</button>
  </div>


  <!-- MAIN APP -->
  <div id="app" class="hidden container">
    <div id="userInfo"></div>

    <nav>
      <button onclick="showSection('allTasks')">All Tasks</button>
      <button onclick="showSection('assignedTasks')">Assigned Tasks</button>
      <button onclick="showSection('doneTasks')">Done</button>
      <button onclick="showSection('prodDash')">Productivity Dashboard</button>
      <button onclick="showSection('attendanceSection')">Attendance</button>
      <button onclick="signOut()">Sign Out</button>
      <button onclick="showSection('approvalSection')">Approval</button>
    </nav>

    <!-- Officer controls -->
    <div id="officerSection" class="hidden" style="margin-top:12px;">
      <h3>Officer Panel</h3>
      <label>Upload Task Excel (.xlsx)</label><br/>
      <input type="file" id="fileInput" accept=".xlsx" />
    </div>

    <div id="approvalSection" class="hidden" style="margin-top:16px;">
      <h3>Officer Approval Panel</h3>
      <div id="approvalList"></div>
      <button onclick="approveAllPending()">Approve All Pending</button>
    </div>

    <div id="allTasks" style="margin-top:12px;"></div>
    <div id="assignedTasks" class="hidden" style="margin-top:12px;"></div>
    <div id="doneTasks" class="hidden" style="margin-top:12px;"></div>
    <div id="allDoneMsg" class="hidden">ðŸŽ‰ All assigned tasks are done!</div>
  </div>

  <!-- XLSX lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // âœ… Correct Firebase project: lae-task-card
    const firebaseConfig = {
      apiKey: "AIzaSyBzNFyDYblJFnLAXhbMiD2HXqtwmNTzqSo",
      authDomain: "lae-task-card-5c839.firebaseapp.com",
      projectId: "lae-task-card-5c839",
      storageBucket: "lae-task-card-5c839.firebasestorage.app",
      messagingSenderId: "405634574463",
      appId: "1:405634574463:web:794553dbf6cd56cef9374a",
      measurementId: "G-9EC3H6T6K4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.doc = doc;
    window.setDoc = setDoc;
    window.getDoc = getDoc;
    window.onSnapshot = onSnapshot;
  </script>

  <script>
    let currentUser = null;
    let allTasks = [];

    const staffNames = [
      "ABDUL FATAH BIN IBRAHIM","MOHD HAFIZ SAZWAN BIN ZAM ZAM",
      "MOHAMMAD ZULKIFLEE BIN HUSSIN","DING JU SHENG",
      "LEE YOONG JUN","MUHAMMAD NAZIF BIN ABDUL MALEK"
    ];

    // ---------- Firestore ----------
    async function saveTaskData() {
      await setDoc(doc(window.db, "taskData", "batikAir"), { tasks: allTasks }, { merge: true });
    }

    async function loadSavedData() {
      const snap = await getDoc(doc(window.db, "taskData", "batikAir"));
      if (snap.exists()) { allTasks = snap.data().tasks || []; }
    }

    function enableRealtimeSync() {
      onSnapshot(doc(window.db, "taskData", "batikAir"), (snap) => {
        if (snap.exists()) { allTasks = snap.data().tasks || []; renderTasks(); }
      });
    }

    // ---------- UI ----------
    function showSection(id, btn) {
      ["allTasks","assignedTasks","doneTasks","approvalSection"].forEach(s => 
        document.getElementById(s).classList.add("hidden")
      );
      document.getElementById(id).classList.remove("hidden");
      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
      if (id === "approvalSection") renderApproval(); else renderTasks();
    }

    function populateNames() {
      const sel = document.getElementById('nameInput');
      sel.innerHTML = '<option value="">Select your name</option>';
      staffNames.forEach(n => { 
        const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o);
      });
    }

    window.onload = function() {
      populateNames();
      document.getElementById('signInBtn').addEventListener('click', async () => {
        const id=document.getElementById('idInput').value.trim();
        const name=document.getElementById('nameInput').value;
        const role=document.getElementById('roleInput').value;
        if(!id||!name||!role){ alert('Fill all fields'); return; }
        currentUser={id,name,role};
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userInfo').textContent=`ID:${id} | Name:${name} | Role:${role}`;
        if(role==="OFFICER") document.getElementById('officerSection').classList.remove('hidden');
        await loadSavedData(); renderTasks(); enableRealtimeSync();
      });
    };

    function signOut(){
      currentUser=null;
      document.getElementById('app').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
    }

    // ---------- Task File Upload ----------
    document.getElementById('fileInput').addEventListener('change', ev=>{
      const f=ev.target.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=async e=>{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const sh=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(sh,{defval:''});
        allTasks=json.map(row=>({
          ata:row['ATA']||'',
          card:row['TASK CARD NUM/ AMM REF']||'',
          description:row['TASK DESCRIPTION']||'',
          assignedTo:row['Assigned To']||'',
          status:'pending', completedBy:'', completedAt:null, verifiedBy:'', verifiedAt:null
        }));
        await saveTaskData(); renderTasks();
      };
      reader.readAsArrayBuffer(f);
    });

    // ---------- Task Actions ----------
    function markTaskDoneByLAE(index){
      if(allTasks[index].status!=="pending")return;
      allTasks[index].status="submitted";
      allTasks[index].completedBy=currentUser.name;
      allTasks[index].completedAt=new Date();
      saveTaskData();
    }

    function verifyTaskByOfficer(index,approved){
      if(allTasks[index].status!=="submitted")return;
      if(approved){
        allTasks[index].status="verified";
        allTasks[index].verifiedBy=currentUser.name;
        allTasks[index].verifiedAt=new Date();
      }else{
        allTasks[index].status="pending"; allTasks[index].completedBy=""; allTasks[index].completedAt=null;
      }
      saveTaskData();
    }

    function approveAllPending(){
      allTasks.forEach((t,i)=>{ if(t.status==="submitted") verifyTaskByOfficer(i,true); });
      renderApproval(); renderTasks();
    }

    function assignTask(index,newName){
      allTasks[index].assignedTo=newName;
      allTasks[index].status="pending";
      allTasks[index].completedBy=""; allTasks[index].completedAt=null;
      allTasks[index].verifiedBy=""; allTasks[index].verifiedAt=null;
      saveTaskData();
    }

    // ---------- Rendering ----------
    function renderTasks(){
      const sAll=document.getElementById('allTasks');
      const sAssigned=document.getElementById('assignedTasks');
      const sDone=document.getElementById('doneTasks');
      [sAll,sAssigned,sDone].forEach(el=>el.innerHTML="");
      allTasks.forEach((t,i)=>{
        const card=document.createElement('div');
        card.className="task-card"+(t.status==="verified"?" done":"");
        card.innerHTML=`<div class="task-header">ATA ${t.ata}</div>
        <div class="block">Card: ${t.card}</div>
        <div class="block">Description: ${t.description}</div>
        <div class="block">Assigned To: <span>${t.assignedTo||'-'}</span></div>
        <div class="block">Status: ${t.status}</div>`;
        const actions=document.createElement('div');
        actions.className="task-actions";

        // Officer can assign
        if(currentUser.role==="OFFICER"){
          const sel=document.createElement('select');
          const def=document.createElement('option');
          def.value=""; def.textContent="-- Assign LAE --";
          sel.appendChild(def);
          staffNames.forEach(n=>{
            const o=document.createElement('option');
            o.value=n; o.textContent=n;
            if(n===t.assignedTo) o.selected=true;
            sel.appendChild(o);
          });
          sel.onchange=()=>assignTask(i,sel.value);
          actions.appendChild(sel);
        }

        if(currentUser.role==="LAE"&&t.assignedTo===currentUser.name&&t.status==="pending"){
          const btn=document.createElement('button'); btn.textContent="Mark Done";
          btn.onclick=()=>markTaskDoneByLAE(i); actions.appendChild(btn);
        }
        if(currentUser.role==="OFFICER"&&t.status==="submitted"){
          const btn=document.createElement('button'); btn.textContent="Approve";
          btn.onclick=()=>verifyTaskByOfficer(i,true); actions.appendChild(btn);
          const btn2=document.createElement('button'); btn2.textContent="Reject";
          btn2.onclick=()=>verifyTaskByOfficer(i,false); actions.appendChild(btn2);
        }
        card.appendChild(actions);

        if(t.status==="verified") sDone.appendChild(card);
        else{
          sAll.appendChild(card);
          if(currentUser.role==="LAE"&&t.assignedTo===currentUser.name) sAssigned.appendChild(card.cloneNode(true));
        }
      });
    }

    function renderApproval(){
      const c=document.getElementById('approvalList'); c.innerHTML="";
      allTasks.forEach((t,i)=>{ if(t.status==="submitted"){
        const div=document.createElement('div'); div.className="task-card";
        div.innerHTML=`<div class="task-header">ATA ${t.ata}</div>
        <div class="block">Card:${t.card}</div>
        <div class="block">Description:${t.description}</div>
        <div class="block">Assigned To:${t.assignedTo}</div>
        <button>Approve</button>`;
        div.querySelector("button").onclick=()=>verifyTaskByOfficer(i,true);
        c.appendChild(div);
      }});
    }
  </script>
</body>
</html>
