<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task & Productivity Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; }
  .hidden { display:none; }
  #mobileMenu { display:none; position:absolute; top:50px; right:10px; background:#fff; border:1px solid #ccc; padding:10px; }
  #mobileMenu.show { display:block; }
  .task-card { border:1px solid #ccc; padding:10px; margin:5px; border-radius:5px; background:#f9f9f9; }
  .task-card.done { background:#d4edda; }
  .task-header { font-weight:bold; margin-bottom:5px; }
  .block { margin:3px 0; }
  .row { display:flex; gap:10px; }
  .meta-pill { background:#eee; padding:2px 5px; border-radius:3px; font-size:0.85em; }
  .assigned-bold { font-weight:bold; }
  .prod-card { border:1px solid #ccc; padding:5px; margin:5px; border-radius:5px; max-height:200px; overflow:auto; }
  .stat-pill { margin:5px; padding:5px; background:#eee; border-radius:5px; display:inline-block; }
  .btn-toggle { margin:5px; padding:5px 10px; border:none; background:#007bff; color:#fff; border-radius:3px; cursor:pointer; }
  table.preview { border-collapse: collapse; width:100%; max-width:100%; overflow:auto; }
  table.preview th, table.preview td { border:1px solid #ccc; padding:3px; text-align:center; }
</style>
</head>
<body>

<div id="loginPage">
  <h2>Login</h2>
  <input type="text" id="idInput" placeholder="ID">
  <select id="nameInput"></select>
  <select id="roleInput">
    <option value="">Select Role</option>
    <option value="OFFICER">Officer</option>
    <option value="LAE">LAE</option>
  </select>
  <button onclick="login()">Login</button>
</div>

<div id="app" class="hidden">
  <div>
    <span id="userInfo"></span>
    <button onclick="signOut()">Sign Out</button>
    <button onclick="toggleMobileMenu()">☰ Menu</button>
    <div id="mobileMenu">
      <button onclick="showSection('allTasks')">All Tasks</button>
      <button onclick="showSection('assignedTasks')">Assigned Tasks</button>
      <button onclick="showSection('doneTasks')">Done Tasks</button>
      <button onclick="showSection('attendanceSection')">Attendance</button>
      <button onclick="showSection('prodDashboard')">Productivity</button>
    </div>
  </div>

  <div id="officerSection" class="hidden">
    <h3>Officer Section</h3>
    <div id="assignedOverview"></div>
  </div>

  <div id="loginTime"></div>

  <input type="file" id="taskInput" accept=".xlsx" onchange="handleFile(event)">

  <!-- Attendance Section -->
  <div id="attendanceSection"></div>

  <div id="allDoneMsg" class="hidden">✅ All assigned tasks done!</div>

  <div class="container">
    <div id="allTasks"></div>
    <div id="assignedTasks" class="hidden"></div>
    <div id="doneTasks" class="hidden"></div>
    <div id="ataFilter"></div>
  </div>

  <!-- Productivity Dashboard -->
  <div id="prodDashboard">
    <h3>Productivity Dashboard</h3>

    <!-- Officer: existing task-based dashboard -->
    <div id="productivityTableOfficer" class="">
      <h4>Task Completion (Officer View)</h4>
      <table border="1">
        <thead><tr><th>LAE</th><th>Assigned</th><th>Done</th><th>% Done</th></tr></thead>
        <tbody id="productivityBody"></tbody>
      </table>
    </div>

    <!-- LAE Productivity -->
    <div id="productivityTableLAE" class="hidden">
      <h4>My Task Completion</h4>
      <div id="myTasksStats" class="stat-pill"></div>
      <div id="myTasksList" class="prod-card"></div>
    </div>

    <!-- Roster & Search -->
    <input type="file" id="rosterInput" accept=".xlsx" onchange="handleRosterFile(event)">
    <input type="text" id="prodSearch" placeholder="Search LAE..." oninput="filterProdLists()">
    <div id="prodCountsPill" class="stat-pill"></div>
    <div class="prod-row">
      <div id="workingList" class="prod-card"></div>
      <div id="offList" class="prod-card"></div>
    </div>
    <button class="btn-toggle" onclick="toggleRosterPreview()">Roster Preview</button>
    <div id="rosterPreview" class="hidden table-wrap"></div>
    <div id="prodDatePill" class="soft"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  // --------------------------
  // Global state
  // --------------------------
  let currentUser = null;
  let allTasks = [];
  let availableATAs = [];
  let staffNames = ["Ali","Ahmad","Sulaiman","Fatimah","Zara"];
  let laeRoster = { "Ali":["Mon","Tue"], "Ahmad":["Mon","Tue","Wed"], "Sulaiman":["Tue","Wed"], "Fatimah":["Mon"], "Zara":["Wed"] };
  let attendance = {};
  let rosterMatrix=[], rosterHeaderRow=-1, rosterNameCol=0;
  let workingToday=[], offToday=[];
  let rosterPreviewVisible=false;

  // --------------------------
  // Mobile menu
  // --------------------------
  function toggleMobileMenu(){ document.getElementById('mobileMenu').classList.toggle('show'); }
  function hideMobileMenu(){ document.getElementById('mobileMenu').classList.remove('show'); }

  // --------------------------
  // Login / Logout
  // --------------------------
  function populateNames(){
    const sel=document.getElementById("nameInput");
    sel.innerHTML='<option value="">Select your name</option>';
    staffNames.forEach(n=>{let o=document.createElement("option");o.value=n;o.textContent=n;sel.appendChild(o)});
  }
  populateNames();

  function login(){
    const id=document.getElementById("idInput").value;
    const name=document.getElementById("nameInput").value;
    const role=document.getElementById("roleInput").value;
    if(!id||!name||!role){alert("Fill all fields");return;}
    currentUser={id,name,role};
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("userInfo").innerText = `ID: ${currentUser.id} | Name: ${currentUser.name} | Role: ${currentUser.role}`;

    if(role==="OFFICER"){ 
      document.getElementById("officerSection").classList.remove("hidden"); 
      document.getElementById("assignedOverview").classList.remove("hidden");
      document.getElementById("productivityTableOfficer").classList.remove("hidden");
      document.getElementById("productivityTableLAE").classList.add("hidden");
    } else {
      document.getElementById("officerSection").classList.add("hidden"); 
      document.getElementById("productivityTableOfficer").classList.add("hidden");
      document.getElementById("productivityTableLAE").classList.remove("hidden");
    }

    updateLoginTime();
    renderAttendance();
    renderTasks();
    updateProdDatePill();
    renderLAEProductivity();
  }

  function updateLoginTime(){
    const now=new Date();
    document.getElementById("loginTime").innerText = "Login Time: "+ now.toLocaleString();
  }

  function signOut(){
    currentUser=null;
    document.getElementById("app").classList.add("hidden");
    document.getElementById("loginPage").classList.remove("hidden");
    document.getElementById("allDoneMsg").classList.add("hidden");
    document.getElementById("userInfo").innerText="";
    hideMobileMenu();
  }

  // --------------------------
  // Tasks
  // --------------------------
  function handleFile(e){
    const file=e.target.files[0];
    const reader=new FileReader();
    reader.onload=function(evt){
      const data=new Uint8Array(evt.target.result);
      const workbook=XLSX.read(data,{type:'array'});
      const sheet=workbook.Sheets[workbook.SheetNames[0]];
      const json=XLSX.utils.sheet_to_json(sheet);
      allTasks=json.map(r=>(({
        ata:r["ATA"]||"",
        card:r["TASK CARD NUM/ AMM REF"]||"",
        description:r["TASK DESCRIPTION"]||"",
        tools:r["TOOLS / TESTSET"]||"",
        consumables:r["CONSUMABLES / MSL"]||"",
        remarks:r["REMARKS"]||"",
        manhour:r["DURATION MANHOUR"]||"",
        due:r["DUE"]||"",
        assignedTo:"",
        done:false
      })));
      availableATAs=[...new Set(allTasks.map(t=>t.ata).filter(v=>v))];
      renderTasks();
      renderLAEProductivity();
    };
    reader.readAsArrayBuffer(file);
  }

  function renderTasks(){
    let ataFilter=document.getElementById("ataSelect")?.value||"ALL";
    let filterFn=t=>(ataFilter==="ALL"||t.ata==ataFilter);
    let sections={allTasks:[], assignedTasks:[], doneTasks:[]};

    allTasks.forEach((t,i)=>{
      if(filterFn(t)){
        if(t.done){sections.doneTasks.push([t,i]);}
        else{
          sections.allTasks.push([t,i]);
          if(t.assignedTo===currentUser?.name){sections.assignedTasks.push([t,i]);}
        }
      }
    });

    if(currentUser?.role==="LAE"){
      const userAssigned=allTasks.filter(t=>t.assignedTo===currentUser.name);
      const userDone=userAssigned.filter(t=>t.done);
      if(userAssigned.length>0 && userAssigned.length===userDone.length){
        document.getElementById("allDoneMsg").classList.remove("hidden");
      }
    }

    if(currentUser?.role==="OFFICER"){
      let overviewDiv=document.getElementById("overviewList");
      let laeTasks={};
      allTasks.forEach(t=>{
        if(t.assignedTo){ 
          if(!laeTasks[t.assignedTo]) laeTasks[t.assignedTo]=[];
          laeTasks[t.assignedTo].push(`${t.card} - ${t.description} ${t.done?'✅':''}`);
        }
      });
      overviewDiv.innerHTML="";
      for(let lae in laeTasks){
        let ul=document.createElement("ul");
        laeTasks[lae].forEach(task=>{ let li=document.createElement("li"); li.textContent=task; ul.appendChild(li); });
        let div=document.createElement("div");
        div.innerHTML=`<b>${lae}:</b>`; 
        div.appendChild(ul);
        overviewDiv.appendChild(div);
      }

      let tbody=document.getElementById("productivityBody");
      tbody.innerHTML="";
      staffNames.forEach(name=>{
        let assigned=allTasks.filter(t=>t.assignedTo===name).length;
        let done=allTasks.filter(t=>t.assignedTo===name && t.done).length;
        let percent=assigned>0? Math.round(done/assigned*100) : 0;
        let tr=document.createElement("tr");
        tr.innerHTML=`<td>${name}</td><td>${assigned}</td><td>${done}</td><td>${percent}%</td>`;
        tbody.appendChild(tr);
      });
    }

    for(let sec in sections){
      let cont=document.getElementById(sec);
      cont.innerHTML="";
      sections[sec].forEach(([t,i])=>{
        let canMark=(currentUser.role==="LAE" && t.assignedTo===currentUser.name && attendance[t.assignedTo]);
        let card=document.createElement("div");
        card.className="task-card"+(t.done?" done":"");
        card.innerHTML=`
          <div class="task-header">ATA ${t.ata}</div>
          <div class="block"><b>Task Card Num / AMM Ref:</b> ${t.card}</div>
          <div class="block"><b>Task Description:</b> ${t.description}</div>
          <div class="block"><b>Tools / Testset:</b> ${t.tools}</div>
          <div class="block"><b>Consumables / MSL:</b> ${t.consumables}</div>
          <div class="block"><b>Remarks:</b> ${t.remarks}</div>
          <div class="row">
            <div class="meta-pill">Duration / Manhour: ${t.manhour||"N/A"}</div>
            <div class="meta-pill">Due: ${t.due||"N/A"}</div>
            <div class="meta-pill">Assigned To: <span class="${t.assignedTo?'assigned-bold':''}">${t.assignedTo||"None"}</span></div>
          </div>
          <div class="task-actions">
            ${ currentUser?.role==="OFFICER"
              ? `Assign:
                  <select onchange="assign(${i}, this.value)">
                    <option value="">Assign to...</option>
                    ${staffNames.map(n=>`<option value="${n}" ${t.assignedTo===n?'selected':''}>${n}</option>`).join("")}
                  </select>` : `` }
            ${ canMark
              ? `<label><input type="checkbox" ${t.done?"checked":""} onchange="markDone(${i}, this.checked)"> Mark Done</label>` : `` }
          </div>`;
        cont.appendChild(card);
      });
    }
    populateATAFilter();
    renderLAEProductivity();
  }

  function assign(i,name){ 
    if(currentUser && currentUser.role==="OFFICER"){ 
      let today=new Date().toLocaleDateString("en-US",{weekday:'short'});
      if(name && !(laeRoster[name]||[]).includes(today)){
        alert(`${name} is off today!`);
        return;
      }
      allTasks[i].assignedTo=name; 
      renderTasks(); 
    } else {
      alert("Only officers can assign tasks.");
    }
  }

  function markDone(i,done){ allTasks[i].done=done; renderTasks(); }

  function populateATAFilter(){
    let div=document.getElementById("ataFilter");
    div.innerHTML="";
    let sel=document.createElement("select");
    sel.id="ataSelect";
    sel.innerHTML='<option value="ALL">All ATA</option>';
    availableATAs.forEach(a=>{ sel.innerHTML+=`<option value="${a}">ATA ${a}</option>`; });
    sel.onchange=()=>renderTasks();
    div.appendChild(sel);
  }

  // --------------------------
  // Attendance & Roster
  // --------------------------
  function renderAttendance(){
    const div=document.getElementById("attendanceSection");
    div.innerHTML="<h3>LAE Attendance</h3>";
    let today=new Date().toLocaleDateString("en-US",{weekday:'short'});
    staffNames.forEach(name=>{
      let present=(laeRoster[name]||[]).includes(today);
      attendance[name]=present;
      let p=document.createElement("p");
      p.textContent=`${name}: ${present ? "Present ✅" : "Off ❌"}`;
      div.appendChild(p);
    });
  }

  function handleRosterFile(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      const data = new Uint8Array(evt.target.result);
      const wb = XLSX.read(data, { type:'array' });
      const targetSheetName = wb.SheetNames.includes("KUL") ? "KUL" : wb.SheetNames[0];
      const sheet = wb.Sheets[targetSheetName];
      const mat = XLSX.utils.sheet_to_json(sheet, { header:1, raw:true });
      rosterMatrix = mat;
      detectHeaderAndNameColumn();
      computeTodayOnOff();
      renderProdLists();
      renderProdStats();
      renderRosterPreview();
    };
    reader.readAsArrayBuffer(file);
  }

  function detectHeaderAndNameColumn(){
    rosterHeaderRow = -1; rosterNameCol = 0;
    let bestRow = -1, bestCount = -1;
    for(let r=0; r<Math.min(rosterMatrix.length, 10); r++){
      let row = rosterMatrix[r]||[];
      let count = row.reduce((acc,cell)=> acc + (isDayNumber(cell)?1:0), 0);
      if(count>bestCount){ bestCount=count; bestRow=r; }
    }
    rosterHeaderRow = bestRow >= 0 ? bestRow : 0;

    let nameCol = 0;
    const headerCandidates = [rosterHeaderRow-1, rosterHeaderRow, rosterHeaderRow+1].filter(x=>x>=0);
    for(const hr of headerCandidates){
      const row = rosterMatrix[hr]||[];
      for(let c=0;c<row.length;c++){
        const v = (row[c]||"").toString().trim().toLowerCase();
        if(v==="name" || v==="employee" || v==="staff" || v==="lae"){ nameCol = c; break; }
      }
    }
    rosterNameCol = nameCol;
  }

  function isDayNumber(cell){
    if(cell == null) return false;
    if(typeof cell === 'number') return cell>=1 && cell<=31;
    const n=parseInt(cell.toString().trim(),10);
    return !isNaN(n) && n>=1 && n<=31;
  }

  function getTodayDayNumberMYT(){
    const nowMY = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kuala_Lumpur'}));
    return nowMY.getDate();
  }

  function findTodayColumnIndex(){
    if(rosterHeaderRow<0 || rosterMatrix.length===0) return -1;
    const header = rosterMatrix[rosterHeaderRow] || [];
    const d = getTodayDayNumberMYT();
    for(let c=0;c<header.length;c++){ if(header[c]===d) return c; }
    for(let c=0;c<header.length;c++){ if((header[c]||"").toString().trim()===String(d)) return c; }
    for(let c=0;c<header.length;c++){ if((header[c]||"").toString().trim()===String(d).padStart(2,'0')) return c; }
    return -1;
  }

  function computeTodayOnOff(){
    workingToday = []; offToday = [];
    const col = findTodayColumnIndex();
    if(col<0) return;
    for(let r=rosterHeaderRow+1; r<rosterMatrix.length; r++){
      const row = rosterMatrix[r]||[];
      let name = (row[rosterNameCol]||"").toString().trim();
      if(!name) continue;
      let code = row[col]||"";
      code = code.toString().trim().toUpperCase();
      const offCodes = ['OFF','AL','SL','ML','EL','PH','MC','OFFDAY','OFF DAY','LEAVE','HOL','PHL','ANNUAL LEAVE','SICK LEAVE'];
      const isOff = (code==="" || offCodes.includes(code));
      if(isOff){ offToday.push({name, code: code || '—'}); } else { workingToday.push({name, code}); }
    }
    workingToday.sort((a,b)=> a.name.localeCompare(b.name));
    offToday.sort((a,b)=> a.name.localeCompare(b.name));
  }

  function renderProdLists(){
    const w = document.getElementById('workingList');
    const o = document.getElementById('offList');
    w.innerHTML=""; o.innerHTML="";
    workingToday.forEach(item=>{
      const div=document.createElement('div');
      div.className='name-item'; div.dataset.name=item.name.toLowerCase();
      div.textContent=`${item.name} (${item.code})`; w.appendChild(div);
    });
    offToday.forEach(item=>{
      const div=document.createElement('div');
      div.className='name-item'; div.dataset.name=item.name.toLowerCase();
      div.textContent=`${item.name} (${item.code})`; o.appendChild(div);
    });
  }

  function renderProdStats(){
    const total = workingToday.length + offToday.length;
    const workPct = total ? Math.round(workingToday.length/total*100) : 0;
    const offPct = total ? (100-workPct) : 0;
    document.getElementById('prodCountsPill').textContent =
      `Total LAEs: ${total} | Working: ${workingToday.length} (${workPct}%) | Off: ${offToday.length} (${offPct}%)`;
  }

  function filterProdLists(){
    const q = document.getElementById('prodSearch').value.trim().toLowerCase();
    ['workingList','offList'].forEach(id=>{
      const parent = document.getElementById(id);
      Array.from(parent.children).forEach(child=>{
        const name = child.dataset.name || '';
        child.style.display = name.includes(q) ? '' : 'none';
      });
    });
  }

  function toggleRosterPreview(){
    rosterPreviewVisible = !rosterPreviewVisible;
    const el = document.getElementById('rosterPreview');
    el.classList.toggle('hidden', !rosterPreviewVisible);
    if(rosterPreviewVisible) renderRosterPreview();
  }

  function renderRosterPreview(){
    const el = document.getElementById('rosterPreview');
    if(!el || !rosterPreviewVisible) return;
    const maxRows = Math.min(rosterMatrix.length, 30);
    const maxCols = Math.min((rosterMatrix[0]||[]).length, 20);
    let html = '<table class="preview"><thead><tr>';
    for(let c=0;c<maxCols;c++){ const head=(rosterMatrix[rosterHeaderRow]||[])[c]; html+=`<th>${head||''}</th>`; }
    html+='</tr></thead><tbody>';
    for(let r=rosterHeaderRow+1;r<maxRows;r++){
      html+='<tr>';
      for(let c=0;c<maxCols;c++){
        const v=rosterMatrix[r] && rosterMatrix[r][c]!=null ? rosterMatrix[r][c] : '';
        html+=`<td>${v}</td>`;
      }
      html+='</tr>';
    }
    html+='</tbody></table>';
    el.innerHTML=html;
  }

  function updateProdDatePill(){
    const nowMY = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kuala_Lumpur'}));
    const nice = nowMY.toLocaleDateString('en-GB', { weekday:'short', day:'2-digit', month:'short', year:'numeric', timeZone:'Asia/Kuala_Lumpur' });
    document.getElementById('prodDatePill').textContent = `Date: ${nice} (MYT)`;
  }

  // --------------------------
  // LAE Productivity Dashboard
  // --------------------------
  function renderLAEProductivity(){
    if(!currentUser || currentUser.role!=="LAE") return;
    const assigned = allTasks.filter(t=>t.assignedTo===currentUser.name);
    const done = assigned.filter(t=>t.done);
    document.getElementById('myTasksStats').textContent = `Assigned: ${assigned.length} | Done: ${done.length} | Pending: ${assigned.length-done.length}`;
    const listDiv = document.getElementById('myTasksList');
    listDiv.innerHTML = "";
    assigned.forEach(t=>{
      const div = document.createElement('div');
      div.textContent=`[${t.done?'✅':'⬜'}] ${t.card} - ${t.description}`;
      listDiv.appendChild(div);
    });
  }

  // Initial
  updateProdDatePill();
</script>
</body>
</html>
