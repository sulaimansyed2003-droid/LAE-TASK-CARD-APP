<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LAE Task Card App (Officer & LAE)</title>

  <!-- PWA hooks (keep these files in the same folder) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#b20b4d">

  <style>
    /* ===== Bright Batik Air theme (high-contrast) ===== */
    :root{
      --bg:#faf7fb;              /* very light background */
      --panel:#ffffff;           /* white cards */
      --border:#e6d6e1;          /* soft border */
      --ink:#2a2430;             /* dark text */
      --muted:#6b6171;           /* subtle text */
      --brand:#b20b4d;           /* Batik magenta */
      --brand-2:#f3b500;         /* Batik golden accent */
      --ok:#16a34a;
      --warn:#f59e0b;
      --due:#e57900;
      --danger:#dc2626;
      --done:#e8fff0;
      --shadow:0 10px 30px rgba(178,11,77,.12);
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:6px 0 16px}
    h1{font-size:1.25rem;margin:0;color:var(--ink)}
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:700;color:var(--brand)
    }
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .pill{font-size:.8rem;color:var(--ink);border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff}
    .glass{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .card{padding:16px;border-radius:16px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    label{display:block;font-size:.85rem;color:var(--muted);margin:12px 0 6px}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--ink)}
    textarea{min-height:90px}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.brand{background:var(--brand);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--border);color:var(--ink)}
    .btn.warn{background:var(--brand-2);color:#3b2600}
    .btn.danger{background:var(--danger);color:#fff}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:860px){.grid.two,.grid.three{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid var(--border);text-align:left;padding:10px;vertical-align:top}
    th{font-size:.85rem;color:var(--muted);font-weight:700;width:220px}
    tr:hover{background:#faf3f7}
    .tabbar{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .tab{padding:10px 12px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:#fff}
    .tab.active{outline:2px solid var(--brand)}
    .center{display:flex;align-items:center;justify-content:center}
    .scroller{max-height:180px;overflow:auto;padding:8px;border-radius:10px;background:#fff;border:1px solid var(--border)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.75rem;font-weight:700}
    .b-ok{background:#eaf8ef;color:#065f2a;border:1px solid #ccebd6}
    .b-warn{background:#fff7eb;color:#6b3b00;border:1px solid #ffe2b8}
    .b-due{background:#fff1e6;color:#6b2e00;border:1px solid #ffd1aa}
    .b-danger{background:#ffeff0;color:#7a0f16;border:1px solid #ffc9ce}
    .doneCard{background:var(--done);border:1px solid #bfe9cc}
    .countBar{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <span class="dot"></span>
        <span>LAE Task Card App</span>
      </div>
      <div class="toolbar">
        <span class="pill" id="clockPill">—</span>
        <span class="pill" id="rolePill">Not signed in</span>
      </div>
    </header>

    <!-- AUTH -->
    <div id="auth" class="glass card">
      <div class="row" style="align-items:center">
        <div class="col" style="max-width:520px">
          <h2 style="margin:0 0 8px;color:var(--brand)">Sign in</h2>
          <p class="muted" style="margin:0 0 12px">Enter your details to continue.</p>
          <label>Name</label>
          <input id="nameInput" placeholder="e.g. Aiman" />
          <label>Staff ID</label>
          <input id="staffIdInput" placeholder="e.g. BID1234" />
          <label>Role</label>
          <select id="roleSelect">
            <option value="LAE">LAE</option>
            <option value="OFFICER">OFFICER</option>
          </select>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn brand" onclick="signIn()">Continue</button>
            <button class="btn ghost" onclick="seedDemo()">Load demo data</button>
          </div>
        </div>
        <div class="col" style="text-align:center">
          <!-- Use your local logo file path if you have it -->
          <img src="batik-air-logo.png" alt="Batik Air" style="max-width:220px;width:60%;height:auto"/>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="glass card" style="display:none">
      <div class="toolbar" style="justify-content:space-between;align-items:center">
        <div class="toolbar">
          <button class="btn ghost" onclick="goBack()">◀ Back</button>
          <div class="pill" id="whoPill">—</div>
        </div>
        <div class="tabbar" id="tabs"></div>
      </div>

      <div class="countBar" id="counts" style="margin:4px 0 8px;display:none"></div>

      <!-- LAE: SEARCH -->
      <section id="tab-search" style="display:none">
        <div class="grid two">
          <div>
            <label>ATA Chapter</label>
            <select id="ataFilter" onchange="renderSearch()"></select>
          </div>
          <div>
            <label>Search by Task Card Number / AMM Ref</label>
            <input id="searchInput" placeholder="e.g. 32-07-00-01 / AMM 32-11-00" oninput="renderSearch()" />
          </div>
        </div>
        <div id="searchResults"></div>
      </section>

      <!-- OFFICER: MANAGE -->
      <section id="tab-manage" style="display:none">
        <div class="grid two">
          <div class="card" style="border:1px solid var(--border)">
            <h3 style="margin:0 0 6px">Add / Edit Task Card</h3>
            <p id="formMode" class="muted" style="margin:0 0 12px">Mode: Create</p>
            <div class="grid">
              <label>ATA</label><input id="f_ata" placeholder="e.g. 12 or 32" />
              <label>Task Card Number / AMM Ref</label><input id="f_tc" placeholder="e.g. 32-07-00-01 / AMM xx-xx" />
              <label>Task Description</label><textarea id="f_desc" placeholder="Short description"></textarea>
              <label>Tools / Test Set</label><textarea id="f_tools" placeholder="List tools or test equipment"></textarea>
              <label>Consumables / MSL</label><textarea id="f_cons" placeholder="Consumables, materials, MSL"></textarea>
              <label>Remarks</label><textarea id="f_rem" placeholder="Notes, cautions, references"></textarea>
              <label>Duration</label><input id="f_dur" placeholder="e.g. 4HRS or 2h 30m" />
              <label>Man Hours</label><input id="f_mh" type="number" step="0.1" placeholder="e.g. 3.5" />
              <label>Due Date</label><input id="f_due" type="date" />
            </div>
            <div class="toolbar" style="margin-top:12px">
              <button class="btn brand" onclick="saveTask()">Save</button>
              <button class="btn ghost" onclick="resetForm()">Reset</button>
            </div>
          </div>

          <div class="card" style="border:1px solid var(--border)">
            <div class="toolbar" style="justify-content:space-between;align-items:center">
              <h3 style="margin:0">All Task Cards</h3>
              <div class="toolbar">
                <input type="file" id="excelFile" accept=".xlsx" style="display:none" />
                <button class="btn warn" onclick="document.getElementById('excelFile').click()">Import Excel (.xlsx)</button>
                <button class="btn ghost" onclick="exportJSON()">Export JSON</button>
              </div>
            </div>
            <p class="muted" style="margin:6px 0">
              Columns supported: <i>ATA</i>, <i>TASK CARD NUM / AMM REF</i>, <i>TASK DESCRIPTION</i>, <i>TOOLS / TESTSET</i>,
              <i>CONSUMABLES / MSL</i>, <i>REMARKS</i>, <i>DURATION</i>, <i>MAN HOURS</i>, <i>DUE DATE</i>.
            </p>
            <div id="listWrap"></div>
          </div>
        </div>
      </section>
    </div>

    <div class="center" style="margin-top:16px">
      <button class="btn ghost" onclick="signOut()">Sign out</button>
    </div>
  </div>

  <!-- SheetJS for .xlsx parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    /* ================= STATE ================= */
    const STORAGE_KEY = 'lae_taskcards_v3';
    let state = {
      user: null,             // { name, staffId, role }
      tasks: [],              // [{id, ata, tc, desc, tools, cons, rem, dur, mh, due, done, doneBy, doneAt}]
      editId: null,
      history: []
    };
    const uid = () => 'id-' + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(2);

    /* ============== CLOCK (live) ============== */
    function startClock(){
      const pill = document.getElementById('clockPill');
      const tick = () => {
        const d = new Date();
        const opts = { weekday:'long', year:'numeric', month:'short', day:'numeric',
                       hour:'2-digit', minute:'2-digit', second:'2-digit' };
        pill.textContent = d.toLocaleString(undefined, opts);
      };
      tick(); setInterval(tick, 1000);
    }
    startClock();

    /* ============== STORAGE ============== */
    function loadLocal(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){ state.tasks = JSON.parse(raw).tasks || []; }
      }catch(e){ console.warn('Local load failed', e); }
    }
    function saveLocal(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({tasks: state.tasks})) }catch(e){}
    }

    /* ============== DEMO DATA ============== */
    function seedDemo(){
      state.tasks = [
        {id:uid(), ata:'12', tc:'32-07-00-01', desc:'Service the nose landing gear shock strut.', tools:'COM-1532 Cart... (sample)', cons:'AEROSHELL-LGF', rem:'Use container as alternate.', dur:'4HRS', mh:4, due:addDaysStr(3), done:false},
        {id:uid(), ata:'20', tc:'CHK-POWER-AC', desc:'Pitot probe power consumption check', tools:'KW05-287 / Clamp Meter AC 400A', cons:'-', rem:'-', dur:'1H', mh:1, due:addDaysStr(1), done:false}
      ];
      saveLocal(); render();
      alert('Demo data loaded.');
    }
    function addDaysStr(n){ const d=new Date(); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }

    /* ============== AUTH ============== */
    function signIn(){
      const name=(document.getElementById('nameInput').value||'User').trim();
      const staffId=(document.getElementById('staffIdInput').value||'').trim();
      const role=document.getElementById('roleSelect').value;
      if(!staffId){ alert('Please enter Staff ID'); return; }
      state.user = {name, staffId, role};
      document.getElementById('rolePill').textContent = role+ ' — ' + name;
      document.getElementById('whoPill').textContent = role + ' • ' + staffId;
      document.getElementById('auth').style.display='none';
      document.getElementById('app').style.display='block';
      state.history=['home'];
      loadLocal();
      buildTabs();
      render();
    }
    function signOut(){ location.reload(); }

    /* ============== NAV ============== */
    function goBack(){
      if(state.history.length>1){
        state.history.pop();
        setTab(state.history[state.history.length-1]);
      }else{
        setTab(state.user.role==='OFFICER'?'manage':'search');
      }
    }
    function buildTabs(){
      const tabs = document.getElementById('tabs');
      tabs.innerHTML='';
      const make=(id,label)=>{const a=document.createElement('button');a.className='tab';a.textContent=label;a.onclick=()=>setTab(id);return a}
      if(state.user.role==='LAE'){
        tabs.appendChild(make('search','Search & View'));
        setTab('search');
      }else{
        tabs.appendChild(make('manage','Manage'));
        tabs.appendChild(make('search','Search & View'));
        setTab('manage');
      }
    }
    function setTab(id){
      for(const el of document.querySelectorAll('[id^="tab-"]')) el.style.display='none';
      const btns = document.querySelectorAll('.tabbar .tab');
      btns.forEach(b=>b.classList.remove('active'));
      const show=document.getElementById('tab-'+id); if(show) show.style.display='block';
      const map = (state.user.role==='OFFICER')?[ 'manage','search']:[ 'search' ];
      const idx = map.indexOf(id); if(idx>-1) btns[idx]?.classList.add('active');
      if(state.history[state.history.length-1]!==id) state.history.push(id);
      if(id==='search') { populateATAFilter(); renderSearch(); }
      else if(id==='manage') { renderList(); }
    }

    /* ============== COUNTS (top bar) ============== */
    function renderCounts(){
      const wrap = document.getElementById('counts');
      if(!state.tasks.length){ wrap.style.display='none'; wrap.innerHTML=''; return; }
      const total = state.tasks.length;
      const done = state.tasks.filter(t=>t.done).length;
      const remain = total - done;
      wrap.style.display='flex';
      wrap.innerHTML = `
        <span class="badge b-ok">Done: ${done}</span>
        <span class="badge b-warn">Remaining: ${remain}</span>
        <span class="badge b-due">Total: ${total}</span>
      `;
    }

    /* ============== CRUD (Officer) ============== */
    function resetForm(){
      state.editId=null;
      document.getElementById('formMode').textContent='Mode: Create';
      ['f_ata','f_tc','f_desc','f_tools','f_cons','f_rem','f_dur','f_mh','f_due'].forEach(id=>document.getElementById(id).value='');
    }
    function fillForm(t){
      state.editId=t.id;
      document.getElementById('formMode').textContent='Mode: Edit #'+t.tc;
      f_ata.value=t.ata||''; f_tc.value=t.tc||''; f_desc.value=t.desc||'';
      f_tools.value=t.tools||''; f_cons.value=t.cons||''; f_rem.value=t.rem||'';
      f_dur.value=t.dur||''; f_mh.value=(t.mh??''); f_due.value=(t.due||'');
    }
    function saveTask(){
      const t={
        ata:f_ata.value.trim(),
        tc:f_tc.value.trim(),
        desc:f_desc.value.trim(),
        tools:f_tools.value.trim(),
        cons:f_cons.value.trim(),
        rem:f_rem.value.trim(),
        dur:f_dur.value.trim(),
        mh: f_mh.value? Number(f_mh.value):null,
        due: f_due.value || ''
      };
      if(!t.ata || !t.tc || !t.desc){ alert('Please fill ATA, Task Card / AMM Ref, and Description.'); return; }
      if(state.editId){
        const i=state.tasks.findIndex(x=>x.id===state.editId);
        if(i>-1) state.tasks[i]={...state.tasks[i],...t};
      }else{
        t.id=uid(); t.done=false;
        state.tasks.unshift(t);
      }
      saveLocal(); resetForm(); renderList(); renderCounts(); alert('Saved.');
    }
    function removeTask(id){
      if(!confirm('Delete this task?')) return;
      state.tasks = state.tasks.filter(x=>x.id!==id);
      saveLocal(); renderList(); renderCounts();
    }
    function editById(id){ const t=state.tasks.find(x=>x.id===id); if(t) fillForm(t); }

    function renderList(){
      const wrap=document.getElementById('listWrap');
      if(!state.tasks.length){ wrap.innerHTML='<p class="muted">No task cards yet.</p>'; return; }
      let html='<table><thead><tr><th>ATA</th><th>Task Card / AMM</th><th>Description</th><th>MH</th><th>Due</th><th>Duration</th><th></th></tr></thead><tbody>';
      for(const t of state.tasks){
        html+=`<tr>
          <td>${esc(t.ata||'')}</td>
          <td>${esc(t.tc||'')}</td>
          <td>${esc(t.desc||'')}</td>
          <td>${esc(t.mh??'—')}</td>
          <td>${esc(t.due||'—')}</td>
          <td>${esc(t.dur||'—')}</td>
          <td style="text-align:right">
            <button class="btn ghost" onclick='editById("${t.id}")'>Edit</button>
            <button class="btn danger" onclick='removeTask("${t.id}")'>Delete</button>
          </td>
        </tr>`;
      }
      html+='</tbody></table>';
      wrap.innerHTML=html;
    }

    /* ============== SEARCH (LAE) ============== */
    function populateATAFilter(){
      const select = document.getElementById('ataFilter');
      const ataset = Array.from(new Set(state.tasks.map(t=>String(t.ata||'').trim()).filter(Boolean)))
        .sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));
      select.innerHTML = '<option value="">All ATA</option>' + ataset.map(a=>`<option value="${esc(a)}">ATA ${esc(a)}</option>`).join('');
    }
    function renderSearch(){
      renderCounts();
      const q=(document.getElementById('searchInput').value||'').toLowerCase();
      const ataSel=(document.getElementById('ataFilter').value||'').trim();
      let results = state.tasks;
      if(ataSel) results = results.filter(t=>String(t.ata||'')===ataSel);
      if(q) results = results.filter(t=>
        (t.tc||'').toLowerCase().includes(q) || (t.desc||'').toLowerCase().includes(q)
      );
      const wrap=document.getElementById('searchResults');
      if(!results.length){ wrap.innerHTML='<p class="muted">No matching task cards.</p>'; return; }
      wrap.innerHTML = results.map(card).join('');
    }

    function card(t){
      const dueInfo = dueBadge(t.due, t.done);
      const doneCls = t.done ? 'doneCard' : '';
      return `
        <div class="card ${doneCls}" style="margin-top:12px;border:1px solid var(--border)">
          <div class="grid two">
            <div>
              <b>ATA ${esc(t.ata||'—')} • ${esc(t.tc||'')}</b>
              <p class="muted" style="margin:6px 0">${esc(t.desc||'—')}</p>
            </div>
            <div style="text-align:right">
              ${dueInfo.badge}
              <div style="margin-top:6px">
                <label style="display:inline-flex;align-items:center;gap:8px">
                  <input type="checkbox" ${t.done?'checked':''} onchange="toggleDone('${t.id}', this.checked)" />
                  Mark as done
                </label>
              </div>
            </div>
          </div>

          <div class="grid three" style="margin-top:10px">
            <div>
              <label>Tools / Test Set</label>
              <div class="scroller">${nl2br(esc(t.tools||'-'))}</div>
            </div>
            <div>
              <label>Consumables / MSL</label>
              <div class="scroller">${nl2br(esc(t.cons||'-'))}</div>
            </div>
            <div>
              <label>Remarks</label>
              <div class="scroller">${nl2br(esc(t.rem||'-'))}</div>
            </div>
          </div>

          <div class="grid three" style="margin-top:10px">
            <div><label>Duration</label><div class="pill">${esc(t.dur||'—')}</div></div>
            <div><label>Man Hours</label><div class="pill">${esc(t.mh??'—')}</div></div>
            <div><label>Due Date</label><div class="pill">${esc(t.due||'—')}</div></div>
          </div>
        </div>
      `;
    }

    function toggleDone(id, val){
      const t = state.tasks.find(x=>x.id===id);
      if(!t) return;
      t.done = val;
      t.doneBy = val ? (state.user?.staffId||'') : null;
      t.doneAt = val ? new Date().toISOString() : null;
      saveLocal(); renderSearch(); renderCounts();
    }

    function dueBadge(dueStr, isDone){
      if(isDone) return {badge:`<span class="badge b-ok">Done</span>`};
      if(!dueStr) return {badge:`<span class="badge b-warn">No due set</span>`};
      const today = new Date(); today.setHours(0,0,0,0);
      const due = parseDateFlexible(dueStr);
      if(!due) return {badge:`<span class="badge b-warn">Invalid due</span>`};
      const days = Math.floor((due - today)/(1000*60*60*24));
      if(days < 0) return {badge:`<span class="badge b-danger">Overdue ${Math.abs(days)}d</span>`};
      if(days === 0) return {badge:`<span class="badge b-due">Due today</span>`};
      if(days <= 3) return {badge:`<span class="badge b-warn">Due in ${days}d</span>`};
      return {badge:`<span class="badge b-ok">Due in ${days}d</span>`};
    }

    function parseDateFlexible(s){
      if(!s) return null;
      // ISO yyyy-mm-dd
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00');
      // dd/mm/yyyy or d/m/yyyy
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if(m){ const [_,d,mo,y]=m; return new Date(`${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}T00:00:00`); }
      const d2 = new Date(s);
      return isNaN(d2.getTime()) ? null : d2;
    }

    /* ============== HELPERS ============== */
    function esc(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function nl2br(s){ return (s||'').replace(/\n/g,'<br>'); }

    /* ============== EXCEL IMPORT ============== */
    document.getElementById('excelFile')?.addEventListener('change', handleExcelFile);
    function handleExcelFile(ev){
      const file = ev.target.files[0];
      if(!file){ alert('No file selected'); return; }
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const sheetName = wb.SheetNames[0];
          const ws = wb.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(ws, { header:1, blankrows:false, defval:'' });
          const parsed = parseExcelRows(rows);
          if(!parsed.length){ alert('No rows parsed. Check your sheet format.'); return; }
          for(const t of parsed){ t.id = uid(); if(typeof t.done!=='boolean') t.done=false; }
          state.tasks = [...parsed, ...state.tasks];
          saveLocal();
          renderList(); populateATAFilter(); renderCounts();
          alert('Excel imported: '+parsed.length+' task(s).');
        }catch(err){ console.error(err); alert('Failed to parse Excel.'); }
      };
      reader.readAsArrayBuffer(file);
      ev.target.value='';
    }

    function parseExcelRows(rows){
      let currentATA = '';
      let headerIdx = -1; let cols = {};
      const out = [];
      for(let r=0;r<rows.length;r++){
        const row = rows[r].map(v=>String(v).trim());
        if(row.length===0) continue;
        const first = (row[0]||'').toUpperCase();
        // ATA line like "ATA 12"
        const m = first.match(/^ATA\s*([0-9A-Z.]+)$/);
        if(m){ currentATA = m[1]; continue; }

        // header row
        if(headerIdx<0 && (first.includes('TASK CARD') || first.includes('AMM'))){
          headerIdx=r;
          for(let i=0;i<row.length;i++){
            const name = row[i].toUpperCase();
            if(name.includes('TASK CARD')) cols.tc=i;
            else if(name.includes('AMM') && cols.tc==null) cols.tc=i;
            else if(name.includes('TASK DESCRIPTION')) cols.desc=i;
            else if(name.includes('TOOLS')) cols.tools=i;
            else if(name.includes('CONSUMABLES')) cols.cons=i;
            else if(name.includes('REMARKS')) cols.rem=i;
            else if(name.includes('DURATION')) cols.dur=i;
            else if(name.includes('MAN') && name.includes('HOUR')) cols.mh=i;   // "MAN HOURS"
            else if(name.includes('DUE')) cols.due=i;                          // "DUE DATE"
            else if(name==='ATA') cols.ata=i;
          }
          continue;
        }
        if(headerIdx<0) continue;                 // skip until header found
        if(row.every(c=>c==='')) continue;        // skip empty rows

        let ata = cols.ata!=null ? (row[cols.ata]||currentATA||'') : (currentATA||'');
        ata = String(ata).trim();
        const tc   = cell(row, cols.tc);
        const desc = cell(row, cols.desc);
        const tools= cell(row, cols.tools);
        const cons = cell(row, cols.cons);
        const rem  = cell(row, cols.rem);
        const dur  = cell(row, cols.dur);
        const mh   = cell(row, cols.mh);
        const due  = cell(row, cols.due);

        if(!(tc||desc)) continue;
        out.push({
          ata, tc, desc, tools, cons, rem, dur,
          mh: mh? Number(mh): null,
          due: due || ''
        });
      }
      return out;
    }
    function cell(row, idx){ if(idx==null) return ''; return String(row[idx]||'').trim(); }

    /* ============== INITIAL RENDER ============== */
    function render(){
      if(document.getElementById('tab-search').style.display!=='none') { populateATAFilter(); renderSearch(); }
      if(document.getElementById('tab-manage').style.display!=='none') renderList();
      renderCounts();
    }

    /* ============== PWA: service worker register ============== */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker.register("/service-worker.js");
      });
    }
  </script>
</body>
</html>
