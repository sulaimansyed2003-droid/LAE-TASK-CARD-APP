<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Batik Air Task Card App</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; color:#222; }
    header { background:#800000; color:white; padding:14px; text-align:center; position:relative; }
    .login-box { display:flex; flex-direction:column; align-items:center; justify-content:center; height:70vh; gap:8px; }
    .login-box input, .login-box select, .login-box button { margin:5px; padding:8px; font-size:16px; min-width:220px; }
    .hidden { display:none !important; }
    .container { padding:20px; max-width:1200px; margin:0 auto; }
    .task-card { background:white; margin:10px 0; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.08); }
    .task-card.done { background:#d4edda; }
    .task-header { font-size:16px; font-weight:700; margin-bottom:8px; color:#800000; }
    .block { margin:6px 0; padding:6px; border-left:4px solid rgba(128,0,0,0.14); background:#fafafa; border-radius:4px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; align-items:center; }
    .meta-pill { background:#eee; padding:6px 10px; border-radius:12px; font-size:13px; }
    .task-actions { margin-top:10px; }
    nav button { margin:5px; padding:8px 12px; border:none; border-radius:5px; background:#800000; color:white; cursor:pointer; }
    nav button.active { background:#007bff !important; }
    #allDoneMsg { text-align:center; font-size:18px; font-weight:bold; color:green; margin:20px 0; }
    #userInfo { background:#fff3f3; padding:10px; border-radius:8px; margin:10px 0; font-weight:bold; color:#800000; }
  </style>
</head>
<body>
  <header>
    <h1>Batik Air Task Card System</h1>
  </header>

  <!-- LOGIN -->
  <div id="loginPage" class="login-box">
    <h2>Sign In</h2>
    <input type="text" id="idInput" placeholder="Enter your ID (e.g., 12345)" />
    <select id="nameInput"><option value="">Loading names...</option></select>
    <select id="roleInput">
      <option value="">Select Role</option>
      <option value="OFFICER">Officer</option>
      <option value="LAE">LAE</option>
    </select>
    <button id="signInBtn">Sign In</button>
    <div id="loginTime"></div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden container">
    <div id="userInfo"></div>

    <nav>
      <button onclick="showSection('allTasks',this)">All Tasks</button>
      <button onclick="showSection('assignedTasks', this)">Assigned</button>
      <button onclick="showSection('doneTasks', this)">Done</button>
      <button onclick="showSection('approvalSection', this)">Approval</button>
      <button onclick="signOut()">Sign Out</button>
    </nav>

    <!-- Officer controls -->
    <div id="officerSection" class="hidden" style="margin-top:12px;">
      <h3>Officer Panel</h3>
      <label>Upload Task Excel (.xlsx)</label><br/>
      <input type="file" id="fileInput" accept=".xlsx" />
    </div>

    <div id="approvalSection" class="hidden" style="margin-top:16px;">
      <h3>Officer Approval Panel</h3>
      <div id="approvalList"></div>
      <button onclick="approveAllPending()">Approve All Pending</button>
    </div>

    <div id="allTasks" style="margin-top:12px;"></div>
    <div id="assignedTasks" class="hidden" style="margin-top:12px;"></div>
    <div id="doneTasks" class="hidden" style="margin-top:12px;"></div>
    <div id="allDoneMsg" class="hidden">ðŸŽ‰ All assigned tasks are done!</div>
  </div>

  <!-- XLSX lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // âœ… Correct Firebase project: lae-task-card
    const firebaseConfig = {
      apiKey: "AIzaSyBzNFyDYblJFnLAXhbMiD2HXqtwmNTzqSo",
      authDomain: "lae-task-card-5c839.firebaseapp.com",
      projectId: "lae-task-card-5c839",
      storageBucket: "lae-task-card-5c839.firebasestorage.app",
      messagingSenderId: "405634574463",
      appId: "1:405634574463:web:794553dbf6cd56cef9374a",
      measurementId: "G-9EC3H6T6K4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.doc = doc;
    window.setDoc = setDoc;
    window.getDoc = getDoc;
    window.onSnapshot = onSnapshot;
  </script>

  <script>
    let currentUser = null;
    let allTasks = [];

    const staffNames = [
      "ABDUL FATAH BIN IBRAHIM","MOHD HAFIZ SAZWAN BIN ZAM ZAM",
      "MOHAMMAD ZULKIFLEE BIN HUSSIN","DING JU SHENG",
      "LEE YOONG JUN","MUHAMMAD NAZIF BIN ABDUL MALEK"
    ];

    // ---------- Firestore ----------
    // Save data to Firestore
    async function saveAppData() {
      try {
        const data = { tasks: allTasks, attendanceRecords };
        await setDoc(doc(window.db, "appData", "batikAir"), data);
        console.log("âœ… Data saved to Firestore");
      } catch (e) {
        console.error("âŒ Firestore save failed:", e);
      }
    }

    // Load data from Firestore (once)
    async function loadSavedData() {
      try {
        const snap = await getDoc(doc(window.db, "appData", "batikAir"));
        if (snap.exists()) {
          const data = snap.data();
          if (data.tasks) allTasks = data.tasks;
          if (data.attendanceRecords) attendanceRecords = data.attendanceRecords;
          availableATAs = [...new Set(allTasks.map(t => t.ata).filter(Boolean))];
          renderTasks();
        }
      } catch (e) {
        console.error("âŒ Firestore load failed:", e);
      }
    }

    // Live updates (sync across devices)
    function enableRealtimeSync() {
      const unsub = onSnapshot(doc(window.db, "appData", "batikAir"), (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (data.tasks) allTasks = data.tasks;
          if (data.attendanceRecords) attendanceRecords = data.attendanceRecords;
          availableATAs = [...new Set(allTasks.map(t => t.ata).filter(Boolean))];
          renderTasks();
        }
      });
    }

    // ---------- UI ----------
    function showSection(id, btn) {
      ["allTasks","assignedTasks","doneTasks","approvalSection"].forEach(s => 
        document.getElementById(s).classList.add("hidden")
      );
      document.getElementById(id).classList.remove("hidden");
      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
      if (id === "approvalSection") renderApproval(); else renderTasks();
    }

    function populateNames() {
      const sel = document.getElementById('nameInput');
      sel.innerHTML = '<option value="">Select your name</option>';
      staffNames.forEach(n => { 
        const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o);
      });
    }

    window.onload = function() {
      populateNames();
      document.getElementById('signInBtn').addEventListener('click', async () => {
        const id=document.getElementById('idInput').value.trim();
        const name=document.getElementById('nameInput').value;
        const role=document.getElementById('roleInput').value;
        if(!id||!name||!role){ alert('Fill all fields'); return; }
        currentUser={id,name,role};
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userInfo').textContent=`ID:${id} | Name:${name} | Role:${role}`;
        if(role==="OFFICER") document.getElementById('officerSection').classList.remove('hidden');
        await loadSavedData(); renderTasks(); enableRealtimeSync();
      });
    };

    function signOut(){
      currentUser=null;
      document.getElementById('app').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
    }

    // ---------- Task File Upload ----------
    document.getElementById('fileInput').addEventListener('change', ev=>{
      const f=ev.target.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=async e=>{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const sh=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(sh,{defval:''});
        allTasks=json.map(row=>({
          ata:row['ATA']||'',
          card:row['TASK CARD NUM/ AMM REF']||'',
          description:row['TASK DESCRIPTION']||'',
          assignedTo:row['Assigned To']||'',
          status:'pending', completedBy:'', completedAt:null, verifiedBy:'', verifiedAt:null
        }));
        await saveTaskData(); renderTasks();
      };
      reader.readAsArrayBuffer(f);
    });

    // ---------- Task Actions ----------
    function markTaskDoneByLAE(index){
      if(allTasks[index].status!=="pending")return;
      allTasks[index].status="submitted";
      allTasks[index].completedBy=currentUser.name;
      allTasks[index].completedAt=new Date();
      saveTaskData();
    }

    function verifyTaskByOfficer(index,approved){
      if(allTasks[index].status!=="submitted")return;
      if(approved){
        allTasks[index].status="verified";
        allTasks[index].verifiedBy=currentUser.name;
        allTasks[index].verifiedAt=new Date();
      }else{
        allTasks[index].status="pending"; allTasks[index].completedBy=""; allTasks[index].completedAt=null;
      }
      saveTaskData();
    }

    function approveAllPending(){
      allTasks.forEach((t,i)=>{ if(t.status==="submitted") verifyTaskByOfficer(i,true); });
      renderApproval(); renderTasks();
    }

    function assignTask(index,newName){
      allTasks[index].assignedTo=newName;
      allTasks[index].status="pending";
      allTasks[index].completedBy=""; allTasks[index].completedAt=null;
      allTasks[index].verifiedBy=""; allTasks[index].verifiedAt=null;
      saveTaskData();
    }

    // ---------- Rendering ----------
    function renderTasks(){
      const sAll=document.getElementById('allTasks');
      const sAssigned=document.getElementById('assignedTasks');
      const sDone=document.getElementById('doneTasks');
      [sAll,sAssigned,sDone].forEach(el=>el.innerHTML="");
      allTasks.forEach((t,i)=>{
        const card=document.createElement('div');
        card.className="task-card"+(t.status==="verified"?" done":"");
        card.innerHTML=`<div class="task-header">ATA ${t.ata}</div>
        <div class="block">Card: ${t.card}</div>
        <div class="block">Description: ${t.description}</div>
        <div class="block">Assigned To: <span>${t.assignedTo||'-'}</span></div>
        <div class="block">Status: ${t.status}</div>`;
        const actions=document.createElement('div');
        actions.className="task-actions";

        // Officer can assign
        if(currentUser.role==="OFFICER"){
          const sel=document.createElement('select');
          const def=document.createElement('option');
          def.value=""; def.textContent="-- Assign LAE --";
          sel.appendChild(def);
          staffNames.forEach(n=>{
            const o=document.createElement('option');
            o.value=n; o.textContent=n;
            if(n===t.assignedTo) o.selected=true;
            sel.appendChild(o);
          });
          sel.onchange=()=>assignTask(i,sel.value);
          actions.appendChild(sel);
        }

        if(currentUser.role==="LAE"&&t.assignedTo===currentUser.name&&t.status==="pending"){
          const btn=document.createElement('button'); btn.textContent="Mark Done";
          btn.onclick=()=>markTaskDoneByLAE(i); actions.appendChild(btn);
        }
        if(currentUser.role==="OFFICER"&&t.status==="submitted"){
          const btn=document.createElement('button'); btn.textContent="Approve";
          btn.onclick=()=>verifyTaskByOfficer(i,true); actions.appendChild(btn);
          const btn2=document.createElement('button'); btn2.textContent="Reject";
          btn2.onclick=()=>verifyTaskByOfficer(i,false); actions.appendChild(btn2);
        }
        card.appendChild(actions);

        if(t.status==="verified") sDone.appendChild(card);
        else{
          sAll.appendChild(card);
          if(currentUser.role==="LAE"&&t.assignedTo===currentUser.name) sAssigned.appendChild(card.cloneNode(true));
        }
      });
    }

    function renderApproval(){
      const c=document.getElementById('approvalList'); c.innerHTML="";
      allTasks.forEach((t,i)=>{ if(t.status==="submitted"){
        const div=document.createElement('div'); div.className="task-card";
        div.innerHTML=`<div class="task-header">ATA ${t.ata}</div>
        <div class="block">Card:${t.card}</div>
        <div class="block">Description:${t.description}</div>
        <div class="block">Assigned To:${t.assignedTo}</div>
        <button>Approve</button>`;
        div.querySelector("button").onclick=()=>verifyTaskByOfficer(i,true);
        c.appendChild(div);
      }});
    }
  </script>
</body>
</html>
