<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Batik Air Task Card System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f9ff; color:#222; margin:20px; }
    h1 { color:#8B0000; }
    .hidden { display:none; }

    .task-card {
      border:1px solid #ccc; border-radius:10px; padding:15px; margin:15px 0;
      background:white; box-shadow:0 2px 5px rgba(0,0,0,0.1);
      line-height:1.5em;
    }
    .done { background:#d4f8d4 !important; }

    /* Colors for details inside task card */
    .task-header { font-weight:bold; font-size:16px; color:#8B0000; margin-bottom:8px; }
    .task-meta { background:#eef7ff; padding:6px; border-radius:6px; margin:4px 0; }
    .task-desc { background:#fff3e6; padding:6px; border-radius:6px; margin:4px 0; }
    .task-tools { background:#e6ffe6; padding:6px; border-radius:6px; margin:4px 0; }
    .task-cons { background:#e6f7ff; padding:6px; border-radius:6px; margin:4px 0; }
    .task-remarks { background:#fff0f0; padding:6px; border-radius:6px; margin:4px 0; }
    .task-actions { margin-top:10px; }

    .header { display:flex; justify-content:space-between; margin-bottom:15px; }
    button { margin:5px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; }
    .logout { background:#8B0000; color:white; }
    .back { background:#555; color:white; }
    .filter-section { margin:10px 0; }
  </style>
</head>
<body>

<h1>Batik Air Task Card System</h1>

<div id="loginSection">
  <h3>Login</h3>
  <label>Name: <select id="nameInput"></select></label><br>
  <label>ID: <input type="text" id="idInput"></label><br>
  <label>Role: 
    <select id="roleInput">
      <option value="LAE">LAE</option>
      <option value="OFFICER">OFFICER</option>
    </select>
  </label><br>
  <button onclick="login()">Sign In</button>
</div>

<div id="appSection" class="hidden">
  <div class="header">
    <div>
      <span id="welcome"></span><br>
      <span id="dateTime"></span><br>
      Task Done: <span id="taskDone">0</span> | Remaining: <span id="taskRemaining">0</span>
    </div>
    <div>
      <button class="back" onclick="back()">Back</button>
      <button class="logout" onclick="logout()">Sign Out</button>
    </div>
  </div>

  <div id="officerSection" class="hidden">
    <h3>Officer Panel</h3>
    <input type="file" id="excelFile" accept=".xlsx" onchange="loadExcel(event)">
  </div>

  <div class="filter-section">
    <label>Filter by ATA: 
      <select id="ataFilter" onchange="renderTasks()">
        <option value="ALL">All ATA</option>
      </select>
    </label>
  </div>

  <button onclick="showAssigned()">Show Assigned To Me</button>
  <button onclick="showAll()">Show All</button>

  <div id="taskList"></div>

  <h3>Finished Tasks</h3>
  <div id="doneList"></div>
</div>

<script>
const staffNames=[
  "ABDUL FATAH BIN IBRAHIM","MOHD HAFIZ SAZWAN BIN ZAM ZAM","MOHAMMAD ZULKIFLEE BIN HUSSIN",
  "DING JU SHENG","LEE YOONG JUN","MUHAMMAD NAZIF BIN ABDUL MALEK" // extend full list
];
let tasks=[],currentUser=null,showOnlyAssigned=false;

function populateNames(){
  const sel=document.getElementById("nameInput");
  sel.innerHTML='<option value="">Select your name</option>';
  staffNames.forEach(n=>{
    let o=document.createElement("option");o.value=n;o.textContent=n;sel.appendChild(o);
  });
}
populateNames();

function login(){
  let name=document.getElementById("nameInput").value;
  let id=document.getElementById("idInput").value;
  let role=document.getElementById("roleInput").value;
  if(!name||!id){alert("Please enter name and ID");return;}
  currentUser={name,id,role};
  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("appSection").classList.remove("hidden");
  document.getElementById("welcome").textContent=`Welcome ${name} (${role})`;
  if(role==="OFFICER") document.getElementById("officerSection").classList.remove("hidden");
  renderTasks();
  startClock();
}
function logout(){
  currentUser=null;tasks=[];
  document.getElementById("appSection").classList.add("hidden");
  document.getElementById("officerSection").classList.add("hidden");
  document.getElementById("taskList").innerHTML="";
  document.getElementById("doneList").innerHTML="";
  document.getElementById("loginSection").classList.remove("hidden");
}
function back(){renderTasks();}
function startClock(){
  function update(){
    document.getElementById("dateTime").textContent=new Date().toLocaleString();
  }
  update();setInterval(update,1000);
}

function loadExcel(e){
  let file=e.target.files[0];let reader=new FileReader();
  reader.onload=function(ev){
    let data=new Uint8Array(ev.target.result);
    let workbook=XLSX.read(data,{type:"array"});
    let sheet=workbook.Sheets[workbook.SheetNames[0]];
    let json=XLSX.utils.sheet_to_json(sheet,{header:1});
    let raw=json.slice(1);let grouped=[];let current=null;
    raw.forEach(r=>{
      let ata=r[0]||"", card=r[1]||"", desc=r[2]||"", tools=r[3]||"", cons=r[4]||"", remarks=r[5]||"",
          manhour=r[6]||"", due=r[7]||"", assigned=r[8]||"";
      if(card===""&&desc===""){
        if(current) grouped.push(current);
        current={ata:ata,card:"",description:"",tools:"",consumables:"",remarks:"",
                 manhour:manhour,due:due,assignedTo:assigned,done:false,markedBy:""};
      } else {
        if(current){
          current.card+=(current.card?" | ":"")+card;
          current.description+=" "+desc;
          if(tools) current.tools+=" "+tools;
          if(cons) current.consumables+=" "+cons;
          if(remarks) current.remarks+=" "+remarks;
        }
      }
    });
    if(current) grouped.push(current);
    tasks=grouped;
    populateATAFilter();
    renderTasks();
  };
  reader.readAsArrayBuffer(file);
}

function populateATAFilter(){
  const sel=document.getElementById("ataFilter");
  let atas=[...new Set(tasks.map(t=>t.ata).filter(x=>x))];
  sel.innerHTML='<option value="ALL">All ATA</option>';
  atas.forEach(a=>{let o=document.createElement("option");o.value=a;o.textContent=a;sel.appendChild(o);});
}

function renderTasks(){
  let filter=document.getElementById("ataFilter").value;
  let container=document.getElementById("taskList");container.innerHTML="";
  let doneC=document.getElementById("doneList");doneC.innerHTML="";
  let show=tasks.filter(t=>{
    if(showOnlyAssigned && currentUser.role==="LAE" && t.assignedTo!==currentUser.name) return false;
    if(filter!=="ALL" && t.ata!==filter) return false;
    return true;
  });
  let doneCount=0,remainCount=0;
  show.forEach((t,i)=>{
    let div=document.createElement("div");
    div.className="task-card"+(t.done?" done":"");
    div.innerHTML=`
      <div class="task-header">${t.ata}</div>
      <div class="task-meta"><b>ATA:</b> ${t.ata} | <b>Manhour:</b> ${t.manhour||"N/A"} | <b>Due:</b> ${t.due||"N/A"} | <b>Assigned To:</b> ${t.assignedTo||"None"}</div>
      <div class="task-meta"><b>Task Card:</b> ${t.card}</div>
      <div class="task-desc"><b>Description:</b> ${t.description}</div>
      <div class="task-tools"><b>Tools:</b> ${t.tools}</div>
      <div class="task-cons"><b>Consumables:</b> ${t.consumables}</div>
      <div class="task-remarks"><b>Remarks:</b> ${t.remarks}</div>
      <div class="task-actions">
        ${currentUser.role==="OFFICER"?`Assign: <select onchange="assign(${i},this.value)"><option value="">Assign to...</option>${staffNames.map(n=>`<option value="${n}">${n}</option>`).join("")}</select>`:""}
        ${currentUser.role==="LAE"?`<label><input type="checkbox" ${t.done?"checked":""} onchange="markDone(${i},this.checked)"> Mark Done</label>`:""}
      </div>
    `;
    if(t.done) doneC.appendChild(div); else container.appendChild(div);
    if(t.done) doneCount++; else remainCount++;
  });
  document.getElementById("taskDone").textContent=doneCount;
  document.getElementById("taskRemaining").textContent=remainCount;
}
function markDone(i,checked){
  if(checked){tasks[i].done=true;tasks[i].markedBy=currentUser.name;}
  else {tasks[i].done=false;tasks[i].markedBy="";}
  renderTasks();
}
function assign(i,name){tasks[i].assignedTo=name;renderTasks();}
function showAssigned(){showOnlyAssigned=true;renderTasks();}
function showAll(){showOnlyAssigned=false;renderTasks();}
</script>

</body>
</html>
