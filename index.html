<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task & Roster Dashboard</title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;}
    .hidden{display:none;}
    #mobileMenu.show{display:block;}
    .task-card{border:1px solid #ccc;margin:5px;padding:5px;border-radius:5px;background:#f9f9f9;}
    .task-card.done{background:#d4edda;}
    .task-header{font-weight:bold;}
    .block{margin:2px 0;}
    .row{display:flex;gap:10px;margin:5px 0;}
    .meta-pill{background:#eee;padding:2px 5px;border-radius:3px;}
    .assigned-bold{font-weight:bold;}
    .soft{font-style:italic;margin:5px 0;}
    .stat-pill{background:#ddd;padding:5px;margin:5px 0;border-radius:5px;display:inline-block;}
    .prod-card,.prod-row{display:flex;gap:10px;margin:5px 0;}
    .btn-toggle{margin:5px;}
    .preview{border-collapse:collapse;}
    .preview th,.preview td{border:1px solid #ccc;padding:3px;}
    .attendance-section{margin:5px 0;padding:5px;border:1px solid #ccc;border-radius:5px;}
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage">
    <h2>Login</h2>
    <input type="text" id="idInput" placeholder="ID">
    <select id="nameInput"></select>
    <select id="roleInput">
      <option value="">Select role</option>
      <option value="OFFICER">OFFICER</option>
      <option value="LAE">LAE</option>
    </select>
    <button onclick="login()">Login</button>
  </div>

  <!-- Main App -->
  <div id="app" class="hidden">
    <div>
      <span id="userInfo"></span>
      <span id="loginTime"></span>
      <button onclick="signOut()">Sign Out</button>
    </div>

    <!-- Officer Section -->
    <div id="officerSection" class="hidden">
      <h3>Officer Overview</h3>
      <div>
        <button onclick="toggleOverview()">Toggle Assigned Tasks Overview</button>
        <div id="overviewList" class="hidden"></div>
      </div>

      <h4>Productivity Dashboard</h4>
      <table border="1">
        <thead><tr><th>LAE</th><th>Assigned</th><th>Done</th><th>% Done</th></tr></thead>
        <tbody id="productivityBody"></tbody>
      </table>
      <div id="prodDatePill" class="soft"></div>

      <!-- LAE Productivity Dashboard -->
      <h4>LAE Productivity Dashboard (Task Completion)</h4>
      <table border="1">
        <thead><tr><th>LAE</th><th>Total Tasks</th><th>Completed Tasks</th><th>Completion %</th></tr></thead>
        <tbody id="laeProdBody"></tbody>
      </table>
    </div>

    <!-- Roster Upload & Search -->
    <input type="file" id="rosterInput" accept=".xlsx" onchange="handleRosterFile(event)">
    <input type="text" id="prodSearch" placeholder="Search LAE..." oninput="filterProdLists()">
    <div id="prodCountsPill" class="stat-pill"></div>
    <div class="prod-row">
      <div id="workingList" class="prod-card"></div>
      <div id="offList" class="prod-card"></div>
    </div>
    <button class="btn-toggle" onclick="toggleRosterPreview()">Roster Preview</button>
    <div id="rosterPreview" class="hidden table-wrap"></div>

    <!-- Attendance -->
    <div id="attendanceSection" class="attendance-section"></div>
    <div id="allDoneMsg" class="hidden">✅ All assigned tasks done!</div>

    <!-- Tasks -->
    <div class="container">
      <div id="allTasks"></div>
      <div id="assignedTasks" class="hidden"></div>
      <div id="doneTasks" class="hidden"></div>
      <div id="ataFilter"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let currentUser=null, allTasks=[], availableATAs=[], staffNames=["Ali","Ahmad","Sulaiman","Fatimah","Zara"];
    let laeRoster={"Ali":["Mon","Tue"],"Ahmad":["Mon","Tue","Wed"],"Sulaiman":["Tue","Wed"],"Fatimah":["Mon"],"Zara":["Wed"]};
    let attendance={}, rosterMatrix=[], rosterHeaderRow=-1, rosterNameCol=0;
    let workingToday=[], offToday=[], rosterPreviewVisible=false;

    // ---------------- Mobile Menu ----------------
    function toggleMobileMenu(){document.getElementById('mobileMenu').classList.toggle('show');}
    function hideMobileMenu(){document.getElementById('mobileMenu').classList.remove('show');}

    // ---------------- Login / Logout ----------------
    function populateNames(){
      const sel=document.getElementById("nameInput");
      sel.innerHTML='<option value="">Select your name</option>';
      staffNames.forEach(n=>{let o=document.createElement("option");o.value=n;o.textContent=n;sel.appendChild(o)});
    }
    populateNames();

    function login(){
      const id=document.getElementById("idInput").value;
      const name=document.getElementById("nameInput").value;
      const role=document.getElementById("roleInput").value;
      if(!id||!name||!role){alert("Fill all fields");return;}
      currentUser={id,name,role};
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      document.getElementById("userInfo").innerText=`ID: ${currentUser.id} | Name: ${currentUser.name} | Role: ${currentUser.role}`;
      if(role==="OFFICER"){ document.getElementById("officerSection").classList.remove("hidden"); }
      else{ document.getElementById("officerSection").classList.add("hidden"); }
      updateLoginTime(); renderAttendance(); renderTasks(); updateProdDatePill();
    }

    function updateLoginTime(){
      const now=new Date();
      document.getElementById("loginTime").innerText = "Login Time: "+ now.toLocaleString();
    }

    function signOut(){
      currentUser=null;
      document.getElementById("app").classList.add("hidden");
      document.getElementById("loginPage").classList.remove("hidden");
      document.getElementById("allDoneMsg").classList.add("hidden");
      document.getElementById("userInfo").innerText="";
      hideMobileMenu();
    }

    // ---------------- Tasks ----------------
    function handleFile(e){
      const file=e.target.files[0];
      const reader=new FileReader();
      reader.onload=function(evt){
        const data=new Uint8Array(evt.target.result);
        const workbook=XLSX.read(data,{type:'array'});
        const sheet=workbook.Sheets[workbook.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(sheet);
        allTasks=json.map(r=>({
          ata:r["ATA"]||"",
          card:r["TASK CARD NUM/ AMM REF"]||"",
          description:r["TASK DESCRIPTION"]||"",
          tools:r["TOOLS / TESTSET"]||"",
          consumables:r["CONSUMABLES / MSL"]||"",
          remarks:r["REMARKS"]||"",
          manhour:r["DURATION MANHOUR"]||"",
          due:r["DUE"]||"",
          assignedTo:"",
          done:false
        }));
        availableATAs=[...new Set(allTasks.map(t=>t.ata).filter(v=>v))];
        renderTasks();
      };
      reader.readAsArrayBuffer(file);
    }

    function renderAttendance(){
      const div=document.getElementById("attendanceSection");
      div.innerHTML="<h3>Attendance</h3><div id='attWorking'></div><div id='attOff'></div>";
      let today=new Date().toLocaleDateString("en-US",{weekday:'short'});
      workingToday.forEach(name=>{});
      staffNames.forEach(name=>{
        let present=(laeRoster[name]||[]).includes(today);
        attendance[name]=present;
      });
      const wDiv=document.getElementById("attWorking"); wDiv.innerHTML="<b>Working Today</b>";
      const oDiv=document.getElementById("attOff"); oDiv.innerHTML="<b>Off Today</b>";
      staffNames.forEach(name=>{
        let p=document.createElement("p"); p.textContent=`${name}: ${(attendance[name]?"✅":"❌")}`;
        if(attendance[name]) wDiv.appendChild(p); else oDiv.appendChild(p);
      });
    }

    function showSection(id){
      document.querySelectorAll(".container > div").forEach(d=>d.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      document.getElementById("allDoneMsg").classList.add("hidden");
      renderTasks();
    }

    function renderTasks(){
      let ataFilter=document.getElementById("ataSelect")?.value||"ALL";
      let filterFn=t=>(ataFilter==="ALL"||t.ata==ataFilter);
      let sections={allTasks:[], assignedTasks:[], doneTasks:[]};
      allTasks.forEach((t,i)=>{
        if(filterFn(t)){
          if(t.done){sections.doneTasks.push([t,i]);}
          else{
            sections.allTasks.push([t,i]);
            if(t.assignedTo===currentUser?.name){sections.assignedTasks.push([t,i]);}
          }
        }
      });

      // LAE all done message
      if(currentUser?.role==="LAE"){
        const userAssigned=allTasks.filter(t=>t.assignedTo===currentUser.name);
        const userDone=userAssigned.filter(t=>t.done);
        if(userAssigned.length>0 && userAssigned.length===userDone.length) document.getElementById("allDoneMsg").classList.remove("hidden");
      }

      // Officer assigned task overview & productivity
      if(currentUser?.role==="OFFICER"){
        let overviewDiv=document.getElementById("overviewList"); overviewDiv.innerHTML="";
        let laeTasks={};
        allTasks.forEach(t=>{
          if(t.assignedTo){ 
            if(!laeTasks[t.assignedTo]) laeTasks[t.assignedTo]=[];
            laeTasks[t.assignedTo].push(`${t.card} - ${t.description} ${t.done?'✅':''}`);
          }
        });
        for(let lae in laeTasks){
          let ul=document.createElement("ul"); laeTasks[lae].forEach(task=>{ let li=document.createElement("li"); li.textContent=task; ul.appendChild(li); });
          let div=document.createElement("div"); div.innerHTML=`<b>${lae}:</b>`; div.appendChild(ul); overviewDiv.appendChild(div);
        }

        // Productivity Dashboard
        let tbody=document.getElementById("productivityBody"); tbody.innerHTML="";
        let laeProdBody=document.getElementById("laeProdBody"); laeProdBody.innerHTML="";
        staffNames.forEach(name=>{
          let assigned=allTasks.filter(t=>t.assignedTo===name).length;
          let done=allTasks.filter(t=>t.assignedTo===name && t.done).length;
          let percent=assigned>0? Math.round(done/assigned*100) : 0;
          let tr=document.createElement("tr");
          tr.innerHTML=`<td>${name}</td><td>${assigned}</td><td>${done}</td><td>${percent}%</td>`;
          tbody.appendChild(tr);
          // LAE Productivity (Task Completion)
          let tr2=document.createElement("tr");
          tr2.innerHTML=`<td>${name}</td><td>${assigned}</td><td>${done}</td><td>${percent}%</td>`;
          laeProdBody.appendChild(tr2);
        });
      }

      // Render task cards
      for(let sec in sections){
        let cont=document.getElementById(sec); cont.innerHTML="";
        sections[sec].forEach(([t,i])=>{
          let canMark=(currentUser.role==="LAE" && t.assignedTo===currentUser.name && attendance[t.assignedTo]);
          let card=document.createElement("div");
          card.className="task-card"+(t.done?" done":"");
          card.innerHTML=`
            <div class="task-header">ATA ${t.ata}</div>
            <div class="block"><b>Task Card Num / AMM Ref:</b> ${t.card}</div>
            <div class="block"><b>Task Description:</b> ${t.description}</div>
            <div class="block"><b>Tools / Testset:</b> ${t.tools}</div>
            <div class="block"><b>Consumables / MSL:</b> ${t.consumables}</div>
            <div class="block"><b>Remarks:</b> ${t.remarks}</div>
            <div class="row">
              <div class="meta-pill">Duration / Manhour: ${t.manhour||"N/A"}</div>
              <div class="meta-pill">Due: ${t.due||"N/A"}</div>
              <div class="meta-pill">Assigned To: <span class="${t.assignedTo?'assigned-bold':''}">${t.assignedTo||"None"}</span></div>
            </div>
            <div class="task-actions">
              ${ currentUser?.role==="OFFICER"
                ? `Assign:
                    <select onchange="assign(${i}, this.value)">
                      <option value="">Assign to...</option>
                      ${staffNames.map(n=>`<option value="${n}" ${t.assignedTo===n?'selected':''}>${n}</option>`).join("")}
                    </select>` : `` }
              ${ canMark
                ? `<label><input type="checkbox" ${t.done?"checked":""} onchange="markDone(${i}, this.checked)"> Mark Done</label>` : `` }
            </div>`;
          cont.appendChild(card);
        });
      }
      populateATAFilter();
    }

    function assign(i,name){ 
      if(currentUser && currentUser.role==="OFFICER"){ 
        let today=new Date().toLocaleDateString("en-US",{weekday:'short'});
        if(name && !(laeRoster[name]||[]).includes(today)){alert(`${name} is off today!`); return;}
        allTasks[i].assignedTo=name; renderTasks();
      } else alert("Only officers can assign tasks.");
    }

    function markDone(i,done){ allTasks[i].done=done; renderTasks(); }

    function populateATAFilter(){
      let div=document.getElementById("ataFilter"); div.innerHTML="";
      let sel=document.createElement("select"); sel.id="ataSelect";
      sel.innerHTML='<option value="ALL">All ATA</option>';
      availableATAs.forEach(a=>{ sel.innerHTML+=`<option value="${a}">ATA ${a}</option>`; });
      sel.onchange=()=>renderTasks(); div.appendChild(sel);
    }

    function toggleOverview(){document.getElementById("overviewList").classList.toggle("hidden");}
    function updateProdDatePill(){
      const nowMY=new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kuala_Lumpur'}));
      const nice=nowMY.toLocaleDateString('en-GB',{ weekday:'short', day:'2-digit', month:'short', year:'numeric', timeZone:'Asia/Kuala_Lumpur' });
      document.getElementById('prodDatePill').textContent = `Date: ${nice} (MYT)`;
    }

    // ---------------- Roster Upload ----------------
    function handleRosterFile(e){
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=function(evt){
        const data=new Uint8Array(evt.target.result);
        const wb=XLSX.read(data,{ type:'array' });
        const targetSheetName = wb.SheetNames.includes("KUL") ? "KUL" : wb.SheetNames[0];
        const sheet=wb.Sheets[targetSheetName];
        const mat=XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});
        rosterMatrix=mat; detectHeaderAndNameColumn(); computeTodayOnOff(); renderProdLists(); renderProdStats(); renderRosterPreview();
      };
      reader.readAsArrayBuffer(file);
    }

    function detectHeaderAndNameColumn(){
      rosterHeaderRow=-1; rosterNameCol=0;
      let bestRow=-1, bestCount=-1;
      for(let r=0;r<Math.min(rosterMatrix.length,10);r++){
        let row=rosterMatrix[r]||[];
        let count=row.reduce((acc,cell)=> acc + (isDayNumber(cell)?1:0),0);
        if(count>bestCount){ bestCount=count; bestRow=r; }
      }
      rosterHeaderRow=bestRow>=0? bestRow:0;
      let nameCol=0;
      [rosterHeaderRow-1,rosterHeaderRow,rosterHeaderRow+1].filter(x=>x>=0).forEach(hr=>{
        const row=rosterMatrix[hr]||[];
        for(let c=0;c<row.length;c++){ const v=(row[c]||"").toString().trim().toLowerCase();
          if(v==="name"||v==="employee"||v==="staff"||v==="lae"){nameCol=c; break;} }
      });
      rosterNameCol=nameCol;
    }

    function isDayNumber(cell){if(cell==null) return false;if(typeof cell==='number') return cell>=1 && cell<=31; const n=parseInt(cell.toString().trim(),10); return !isNaN(n) && n>=1 && n<=31;}
    function getTodayDayNumberMYT(){return new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kuala_Lumpur'})).getDate();}
    function findTodayColumnIndex(){if(rosterHeaderRow<0||rosterMatrix.length===0) return -1; const header=rosterMatrix[rosterHeaderRow]||[]; const d=getTodayDayNumberMYT();
      for(let c=0;c<header.length;c++) if(typeof header[c]==='number' && header[c]===d) return c;
      for(let c=0;c<header.length;c++) if((header[c]||"").toString().trim()===String(d)) return c;
      for(let c=0;c<header.length;c++) if((header[c]||"").toString().trim()===String(d).padStart(2,'0')) return c;
      return -1;
    }

    function computeTodayOnOff(){
      workingToday=[]; offToday=[];
      const col=findTodayColumnIndex();
      if(col<0){ console.error("Could not find today's column in roster"); return; }
      for(let r=rosterHeaderRow+1;r<rosterMatrix.length;r++){
        const row=rosterMatrix[r]||[];
        let name=(row[rosterNameCol]||"").toString().trim(); if(!name) continue;
        let code=row[col]; if(code==null) code=""; code=code.toString().trim().toUpperCase();
        const offCodes=['OFF','AL','SL','ML','EL','PH','MC','OFFDAY','OFF DAY','LEAVE','HOL','PHL','ANNUAL LEAVE','SICK LEAVE'];
        const isOff=(code===""||offCodes.includes(code));
        if(isOff) offToday.push({name,code:code||'—'}); else workingToday.push({name,code});
      }
      workingToday.sort((a,b)=> a.name.localeCompare(b.name));
      offToday.sort((a,b)=> a.name.localeCompare(b.name));
    }

    function renderProdLists(){
      const w=document.getElementById('workingList'); const o=document.getElementById('offList'); w.innerHTML=""; o.innerHTML="";
      workingToday.forEach(item=>{ const div=document.createElement('div'); div.className='name-item'; div.dataset.name=item.name.toLowerCase(); div.textContent=`${item.name} (${item.code})`; w.appendChild(div); });
      offToday.forEach(item=>{ const div=document.createElement('div'); div.className='name-item'; div.dataset.name=item.name.toLowerCase(); div.textContent=`${item.name} (${item.code})`; o.appendChild(div); });
    }

    function renderProdStats(){
      const total=workingToday.length+offToday.length;
      const workPct=total? Math.round(workingToday.length/total*100):0; const offPct=total? 100-workPct:0;
      document.getElementById('prodCountsPill').textContent=`Total LAEs: ${total} | Working: ${workingToday.length} (${workPct}%) | Off: ${offToday.length} (${offPct}%)`;
    }

    function filterProdLists(){
      const q=document.getElementById('prodSearch').value.trim().toLowerCase();
      ['workingList','offList'].forEach(id=>{
        const parent=document.getElementById(id);
        Array.from(parent.children).forEach(child=>{const name=child.dataset.name||''; child.style.display=name.includes(q)?'':'none';});
      });
    }

    function toggleRosterPreview(){
      rosterPreviewVisible=!rosterPreviewVisible;
      const el=document.getElementById('rosterPreview'); el.classList.toggle('hidden', !rosterPreviewVisible);
      if(rosterPreviewVisible) renderRosterPreview();
    }

    function renderRosterPreview(){
      const el=document.getElementById('rosterPreview'); if(!el || !rosterPreviewVisible) return;
      const maxRows=Math.min(rosterMatrix.length,30); const maxCols=Math.min((rosterMatrix[0]||[]).length,20);
      let html='<table class="preview"><thead><tr>';
      for(let c=0;c<maxCols;c++){ const head=(rosterMatrix[rosterHeaderRow]||[])[c]; html+=`<th>${head||''}</th>`; } html+='</tr></thead><tbody>';
      for(let r=rosterHeaderRow+1;r<maxRows;r++){ html+='<tr>'; for(let c=0;c<maxCols;c++){ const v=rosterMatrix[r] && rosterMatrix[r][c]!=null? rosterMatrix[r][c] :''; html+=`<td>${v}</td>`; } html+='</tr>'; } html+='</tbody></table>'; el.innerHTML=html;
    }

    updateProdDatePill();
  </script>
</body>
</html>
