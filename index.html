<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Batik Air Task Card System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- SheetJS for .xlsx parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f9ff; color:#222; margin:20px; }
    h1 { color:#8B0000; margin-top:0; text-align:center; }

    .hidden { display:none; }

    .header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px; gap:10px; }
    .stats { margin-top:6px; font-weight:600; }
    button { margin:5px; padding:8px 14px; border:none; border-radius:8px; cursor:pointer; }
    .logout { background:#8B0000; color:white; }
    .back { background:#555; color:white; }
    .tab-btn { background:#317EFB; color:white; }

    .filter-section { margin:10px 0 6px; }

    .task-card {
      border:1px solid #d7e1f5; border-radius:12px; padding:14px; margin:14px 0;
      background:#ffffff; box-shadow:0 2px 6px rgba(0,0,0,0.06);
      line-height:1.55;
    }
    .done { background:#dff8e3 !important; border-color:#bfe8c6; }

    .task-header { font-weight:bold; font-size:16px; color:#8B0000; margin-bottom:8px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; }
    .meta-pill {
      background:#eef7ff; padding:6px 10px; border-radius:999px; border:1px solid #d9ebff;
      font-size:13px; white-space:nowrap;
    }

    .block { margin-top:8px; }
    .task-meta    { background:#eef7ff; padding:8px; border-radius:10px; border:1px solid #d9ebff; }
    .task-desc    { background:#fff3e6; padding:8px; border-radius:10px; border:1px solid #ffe0c2; }
    .task-tools   { background:#e6ffe6; padding:8px; border-radius:10px; border:1px solid #c8efc8; }
    .task-cons    { background:#e6f7ff; padding:8px; border-radius:10px; border:1px solid #cfeaff; }
    .task-remarks { background:#fff0f0; padding:8px; border-radius:10px; border:1px solid #ffd6d9; }

    .task-actions { margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .assigned-bold { font-weight:bold; color:#000; }

    select, input[type="text"] {
      padding:8px 10px; border:1px solid #cfd9ee; border-radius:8px; background:#fff;
    }

    /* Center login form */
    #loginSection {
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      height:70vh;
      text-align:center;
    }
    #loginSection .block {
      margin:10px 0;
    }

    /* Label styling */
    .lbl { font-weight:bold; }
  </style>
</head>
<body>

<h1>Batik Air Task Card System</h1>

<!-- Login -->
<div id="loginSection">
  <h3>Login</h3>
  <div class="block">
    <label>Name: <select id="nameInput"></select></label>
  </div>
  <div class="block">
    <label>ID: <input type="text" id="idInput" placeholder="e.g. BID1234"></label>
  </div>
  <div class="block">
    <label>Role:
      <select id="roleInput">
        <option value="LAE">LAE</option>
        <option value="OFFICER">OFFICER</option>
      </select>
    </label>
  </div>
  <div id="loginDateTime" style="margin:10px 0; font-weight:bold;"></div>
  <button onclick="login()">Sign In</button>
</div>

<!-- App -->
<div id="appSection" class="hidden">
  <div class="header">
    <div>
      <div id="welcome" style="font-weight:bold;"></div>
      <div id="dateTime" class="stats"></div>
      <div class="stats">Task Done: <span id="taskDone">0</span> | Remaining: <span id="taskRemaining">0</span></div>
    </div>
    <div>
      <button class="back" onclick="back()">Back</button>
      <button class="logout" onclick="logout()">Sign Out</button>
    </div>
  </div>

  <!-- Officer panel -->
  <div id="officerSection" class="hidden">
    <h3>Officer Panel</h3>
    <input type="file" id="excelFile" accept=".xlsx" onchange="loadExcel(event)">
  </div>

  <!-- Filters -->
  <div class="filter-section">
    <label>Filter by ATA:
      <select id="ataFilter" onchange="renderTasks()">
        <option value="ALL">All ATA</option>
      </select>
    </label>
  </div>

  <!-- Tabs (LAE only) -->
  <div id="tabs" class="hidden">
    <button class="tab-btn" onclick="setTab('ALL')">All Task Cards</button>
    <button class="tab-btn" onclick="setTab('ASSIGNED')">Assigned To Me</button>
    <button class="tab-btn" onclick="setTab('DONE')">Done Task Cards</button>
  </div>

  <!-- Task list -->
  <div id="taskList"></div>
</div>

<script>
/* ======= Names (you can extend/replace this list with your full roster) ======= */
const staffNames = [
  "ABDUL FATAH BIN IBRAHIM","MOHD HAFIZ SAZWAN BIN ZAM ZAM","MOHAMMAD ZULKIFLEE BIN HUSSIN",
  "DING JU SHENG","LEE YOONG JUN","MUHAMMAD NAZIF BIN ABDUL MALEK",
  "UMEIR BIN SHUKRY OMAR TALIB","MOHD MAHDIR BIN ABDUL MANAN","ABU NOR RAZY BIN ABDULLAH @ ANBARASU",
  "ZARIN DARUS BIN ABDUL RAHMAN","MOHAMMAD ZAHID BIN AFTAB","AJMER SINGH A/L SUKHBIR SINGH",
  "MOHD SYAKIR BIN ROSLE","SASHVIREN SINGH A/L SUKHDEV SINGH","MADIHAH BINTI MOHAMED KHAZIN"
  // … add the remaining names …
];

/* ======= Storage Keys ======= */
const TASKS_KEY = "batik_tasks_v1";

/* ======= App State ======= */
let tasks = [];
let currentUser = null;
let currentTab = "ALL";

/* ======= Populate Names ======= */
function populateNames(){
  const sel=document.getElementById("nameInput");
  sel.innerHTML='<option value="">Select your name</option>';
  staffNames.forEach(n=>{
    const o=document.createElement("option");
    o.value=n; o.textContent=n; sel.appendChild(o);
  });
}
populateNames();

/* ======= Clock ======= */
function startClock(){
  function update(){
    const now = new Date();
    const nice = now.toLocaleDateString("en-GB", { weekday:"long", year:"numeric", month:"short", day:"numeric" })
               + " " + now.toLocaleTimeString();
    document.getElementById("dateTime").textContent = nice;
    document.getElementById("loginDateTime").textContent = "Now: " + nice;
  }
  update();
  setInterval(update, 1000);
}
startClock();

/* ======= Local Storage ======= */
function saveTasks(){ localStorage.setItem(TASKS_KEY, JSON.stringify(tasks)); }
function loadTasks(){
  const raw = localStorage.getItem(TASKS_KEY);
  if(raw) tasks = JSON.parse(raw) || [];
}

/* ======= Auth ======= */
function login(){
  const name=document.getElementById("nameInput").value;
  const id=document.getElementById("idInput").value.trim();
  const role=document.getElementById("roleInput").value;
  if(!name||!id){ alert("Please select your name and enter ID"); return; }

  currentUser={name,id,role};
  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("appSection").classList.remove("hidden");
  document.getElementById("welcome").textContent=`Welcome ${name} (${role})`;
  if(role==="OFFICER"){
    document.getElementById("officerSection").classList.remove("hidden");
    document.getElementById("tabs").classList.add("hidden");
  } else {
    document.getElementById("officerSection").classList.add("hidden");
    document.getElementById("tabs").classList.remove("hidden");
  }

  loadTasks();
  populateATAFilter();
  renderTasks();
}
function logout(){
  currentUser=null;
  currentTab="ALL";
  document.getElementById("appSection").classList.add("hidden");
  document.getElementById("officerSection").classList.add("hidden");
  document.getElementById("taskList").innerHTML="";
  document.getElementById("tabs").classList.add("hidden");
  document.getElementById("loginSection").classList.remove("hidden");
}
function back(){ renderTasks(); }

/* ======= Excel Upload ======= */
function loadExcel(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const data=new Uint8Array(ev.target.result);
      const wb=XLSX.read(data,{type:"array"});
      const sheet=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(sheet,{header:1,defval:""});
      const body=rows.slice(1);
      const loaded=body.map(r=>({
        ata:String(r[0]||"").trim(),
        card:String(r[1]||"").trim(),
        description:String(r[2]||"").trim(),
        tools:String(r[3]||"").trim(),
        consumables:String(r[4]||"").trim(),
        remarks:String(r[5]||"").trim(),
        manhour:String(r[6]||"").trim(),
        due:String(r[7]||"").trim(),
        assignedTo:String(r[8]||"").trim(),
        done:false, markedBy:""
      }));
      tasks=loaded;
      saveTasks();
      populateATAFilter();
      renderTasks();
      alert("Excel imported: "+loaded.length+" task(s).");
    }catch(err){ console.error(err); alert("Failed to parse Excel."); }
  };
  reader.readAsArrayBuffer(file);
}

/* ======= Filters & Tabs ======= */
function populateATAFilter(){
  const sel=document.getElementById("ataFilter");
  const atas=[...new Set(tasks.map(t=>t.ata).filter(Boolean))].sort();
  sel.innerHTML='<option value="ALL">All ATA</option>';
  atas.forEach(a=>{
    const o=document.createElement("option"); o.value=a; o.textContent=a; sel.appendChild(o);
  });
}
function setTab(tab){ currentTab=tab; renderTasks(); }

/* ======= Assign & Done ======= */
function assign(i,name){ tasks[i].assignedTo=name; saveTasks(); renderTasks(); }
function markDone(i,checked){
  if(currentUser?.role!=="LAE"){ alert("Only LAE can mark tasks done."); }
  tasks[i].done=!!checked; tasks[i].markedBy=checked?currentUser.name:"";
  saveTasks(); renderTasks();
}

/* ======= Render ======= */
function renderTasks(){
  const filter=document.getElementById("ataFilter").value;
  const container=document.getElementById("taskList");
  container.innerHTML="";
  let doneCount=0,remainCount=0;

  const filtered=tasks.filter(t=>{
    if(filter!=="ALL"&&t.ata!==filter) return false;
    if(currentUser?.role==="LAE"){
      if(currentTab==="ASSIGNED") return t.assignedTo===currentUser.name;
      if(currentTab==="DONE") return !!t.done;
      return true;
    }
    return true;
  });

  filtered.forEach((t,i)=>{
    if(t.done) doneCount++; else remainCount++;
    const card=document.createElement("div");
    card.className="task-card"+(t.done?" done":"");
    card.innerHTML=`
      <div class="task-header">${escapeHtml(t.ata||"—")}</div>
      <div class="row">
        <div class="meta-pill"><span class="lbl">ATA:</span> ${escapeHtml(t.ata||"—")}</div>
        <div class="meta-pill"><span class="lbl">Manhour:</span> ${escapeHtml(t.manhour||"N/A")}</div>
        <div class="meta-pill"><span class="lbl">Due:</span> ${escapeHtml(t.due||"N/A")}</div>
        <div class="meta-pill"><span class="lbl">Assigned To:</span>
          <span class="${t.assignedTo?'assigned-bold':''}">${escapeHtml(t.assignedTo||"None")}</span>
        </div>
      </div>
      <div class="block task-meta"><span class="lbl">Task Card:</span> ${escapeHtml(t.card||"—")}</div>
      <div class="block task-desc"><span class="lbl">Description:</span> ${escapeHtml(t.description||"—")}</div>
      <div class="block task-tools"><span class="lbl">Tools:</span> ${escapeHtml(t.tools||"—")}</div>
      <div class="block task-cons"><span class="lbl">Consumables:</span> ${escapeHtml(t.consumables||"—")}</div>
      <div class="block task-remarks"><span class="lbl">Remarks:</span> ${escapeHtml(t.remarks||"—")}</div>
      <div class="task-actions">
        ${currentUser?.role==="OFFICER"
          ? `Assign:<select onchange="assign(${indexInAll(i,filtered)},this.value)">
              <option value="">Assign to...</option>
              ${staffNames.map(n=>`<option value="${escapeHtml(n)}" ${t.assignedTo===n?'selected':''}>${escapeHtml(n)}</option>`).join("")}
             </select>`:""}
        ${currentUser?.role==="LAE"
          ? `<label><input type="checkbox" ${t.done?"checked":""} onchange="markDone(${indexInAll(i,filtered)},this.checked)"> Mark Done</label>`:""}
      </div>`;
    container.appendChild(card);
  });

  document.getElementById("taskDone").textContent=doneCount;
  document.getElementById("taskRemaining").textContent=remainCount;
}
function indexInAll(filteredIndex,filteredArray){ return tasks.indexOf(filteredArray[filteredIndex]); }
function escapeHtml(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
</script>

</body>
</html>
