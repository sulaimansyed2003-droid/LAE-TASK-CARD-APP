<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Batik Air Task Card App</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    header { background:#800000; color:white; padding:10px; text-align:center; }
    .login-box { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
    .login-box input, .login-box select, .login-box button { margin:5px; padding:8px; font-size:16px; }
    .hidden { display:none; }
    .container { padding:20px; }
    .task-card { background:white; margin:10px 0; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
    .task-card.done { background:#d4edda; }
    .task-header { font-size:18px; font-weight:bold; margin-bottom:10px; color:#800000; }
    .block { margin:5px 0; padding:6px; border-left:4px solid #80000022; background:#fafafa; }
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0; }
    .meta-pill { background:#eee; padding:5px 10px; border-radius:12px; font-size:14px; }
    .task-actions { margin-top:10px; }
    .assigned-bold { font-weight:bold; color:#800000; }
    nav button { margin:5px; padding:8px 12px; border:none; border-radius:5px; background:#800000; color:white; cursor:pointer; }
    nav button:hover { background:#a00000; }
    #allDoneMsg { text-align:center; font-size:18px; font-weight:bold; color:green; margin:20px 0; }
    #assignedOverview { background:#fff3f3; padding:10px; border-radius:8px; margin:15px 0; }
    #assignedOverview h3 { color:#800000; margin-bottom:10px; }
    #assignedOverview ul { list-style:none; padding-left:0; }
    #assignedOverview li { margin:4px 0; }
    #userInfo { background:#fff3f3; padding:10px; border-radius:8px; margin:10px 0; font-weight:bold; color:#800000; }
    .btn-toggle { margin:5px 0; padding:6px 10px; background:#800000; color:white; border:none; border-radius:5px; cursor:pointer; }
    .btn-toggle:hover { background:#a00000; }
    #productivityDashboard { background:#f0f0f0; padding:10px; border-radius:8px; margin:15px 0; }
    #productivityDashboard h3 { color:#800000; margin-bottom:10px; }
    #productivityDashboard table { width:100%; border-collapse: collapse; }
    #productivityDashboard th, #productivityDashboard td { border:1px solid #ccc; padding:6px; text-align:left; }
    #attendanceSection { margin:10px 0; }

    /* Productivity Dashboard (Roster Upload) */
    #prodDash { background:#ffffff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:16px; }
    #prodDash h2 { color:#800000; margin-top:0; }
    .prod-row { display:flex; gap:16px; flex-wrap:wrap; }
    .prod-card { flex:1; min-width:260px; background:#fafafa; border-left:4px solid #80000022; border-radius:8px; padding:12px; }
    .prod-card h3 { margin:0 0 8px; color:#800000; }
    #prodSearch { width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; }
    .name-item { padding:6px 8px; background:#fff; border:1px solid #eee; border-radius:8px; margin:6px 0; }
    .stat-pill { display:inline-block; padding:6px 10px; border-radius:16px; background:#fff; border:1px solid #eee; margin-right:8px; }
    .soft { color:#555; }
    .table-wrap { max-height:320px; overflow:auto; border:1px solid #eee; border-radius:8px; background:#fff; }
    table.preview { width:100%; border-collapse:collapse; }
    table.preview th, table.preview td { border:1px solid #eee; padding:6px; font-size:12px; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <header><h1>Batik Air Task Card System</h1></header>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="login-box">
    <h2>Login</h2>
    <input type="text" id="idInput" placeholder="Enter your ID">
    <select id="nameInput"></select>
    <select id="roleInput">
      <option value="">Select Role</option>
      <option value="OFFICER">Officer</option>
      <option value="LAE">LAE</option>
    </select>
    <button onclick="login()">Sign In</button>
    <div id="loginTime"></div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden">
    <div id="userInfo"></div>

    <nav>
      <button onclick="showSection('allTasks')">All Tasks</button>
      <button onclick="showSection('assignedTasks')">Assigned Tasks</button>
      <button onclick="showSection('doneTasks')">Done</button>
      <button onclick="showSection('prodDash')">Productivity Dashboard</button>
      <button onclick="signOut()">Sign Out</button>
    </nav>

    <div id="officerSection" class="hidden">
      <h2>Officer Panel</h2>
      <input type="file" id="fileInput" accept=".xlsx" onchange="handleFile(event)">
      <div id="assignedOverview" class="hidden">
        <h3>Assigned Tasks Overview</h3>
        <button class="btn-toggle" onclick="toggleOverview()">Show/Hide Assigned Tasks</button>
        <div id="overviewList" class="hidden"></div>
      </div>

      <div id="productivityDashboard">
        <h3>LAE Productivity Dashboard (Task Completion)</h3>
        <table>
          <thead>
            <tr><th>LAE</th><th>Tasks Assigned</th><th>Tasks Done</th><th>Productivity %</th></tr>
          </thead>
          <tbody id="productivityBody"></tbody>
        </table>
      </div>
    </div>

    <div class="container">
      <div id="attendanceSection"></div>
      <div id="ataFilter"></div>
      <div id="allTasks"></div>
      <div id="assignedTasks" class="hidden"></div>
      <div id="doneTasks" class="hidden"></div>
      <div id="prodDash" class="hidden">
        <h2>Productivity Dashboard (Roster)</h2>
        <p class="soft">Upload the roster Excel to see who is <b>Working Today</b> vs <b>Off Today</b>. Auto-detects Malaysia time (GMT+8).</p>
        <div class="prod-row" style="align-items:center;">
          <div>
            <input type="file" id="prodFileInput" accept=".xlsx" onchange="handleRosterFile(event)">
          </div>
          <div><span class="stat-pill" id="prodDatePill">Date: ‚Äî</span></div>
          <div><span class="stat-pill" id="prodCountsPill">Total LAEs: ‚Äî | Working: ‚Äî | Off: ‚Äî</span></div>
        </div>
        <div class="prod-row" style="margin-top:12px;">
          <input id="prodSearch" type="text" placeholder="Search LAE by name..." oninput="filterProdLists()">
        </div>

        <div class="prod-row" style="margin-top:12px;">
          <div class="prod-card">
            <h3>‚úÖ Working Today</h3>
            <div id="workingList"></div>
          </div>
          <div class="prod-card">
            <h3>‚ùå Off Today</h3>
            <div id="offList"></div>
          </div>
        </div>

        <div class="prod-row" style="margin-top:12px;">
          <div class="prod-card" style="flex:1 1 100%;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h3>Roster Preview (Optional)</h3>
              <button class="btn-toggle" onclick="toggleRosterPreview()">Show/Hide</button>
            </div>
            <div id="rosterPreview" class="table-wrap hidden"></div>
            <p class="muted">Tip: Make sure the top header row has day numbers (1‚Äì31) and the first column has names.</p>
          </div>
        </div>
      </div>
      <div id="allDoneMsg" class="hidden">üéâ All assigned tasks are done for now!</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let staffNames = [
      "ABDUL FATAH BIN IBRAHIM","MOHD HAFIZ SAZWAN BIN ZAM ZAM","MOHAMMAD ZULKIFLEE BIN HUSSIN",
      "DING JU SHENG","LEE YOONG JUN","MUHAMMAD NAZIF BIN ABDUL MALEK"
    ];

    // Example roster data for in-app attendance section (working days)
    let laeRoster = {
      "ABDUL FATAH BIN IBRAHIM": ["Mon","Tue","Wed","Thu","Fri"],
      "MOHD HAFIZ SAZWAN BIN ZAM ZAM": ["Mon","Tue","Thu","Fri"],
      "MOHAMMAD ZULKIFLEE BIN HUSSIN": ["Tue","Wed","Thu"],
      "DING JU SHENG": ["Mon","Wed","Fri"],
      "LEE YOONG JUN": ["Tue","Thu","Fri"],
      "MUHAMMAD NAZIF BIN ABDUL MALEK": ["Mon","Tue","Wed","Thu","Fri"]
    };

    let allTasks = [];
    let currentUser = null;
    let availableATAs = [];
    let attendance = {}; // simple presence marker for the in-app attendance card

    // --- NEW: Roster Dashboard State ---
    let rosterMatrix = [];      // 2D array from uploaded Excel (header:1)
    let rosterHeaderRow = -1;   // index of header row with day numbers
    let rosterNameCol = 0;      // column index holding names
    let workingToday = [];      // [{name, code}]
    let offToday = [];          // [{name, code}]
    let rosterPreviewVisible = false;

    function populateNames(){
      const sel=document.getElementById("nameInput");
      sel.innerHTML='<option value="">Select your name</option>';
      staffNames.forEach(n=>{let o=document.createElement("option");o.value=n;o.textContent=n;sel.appendChild(o)});
    }
    populateNames();

    function login(){
      const id=document.getElementById("idInput").value;
      const name=document.getElementById("nameInput").value;
      const role=document.getElementById("roleInput").value;
      if(!id||!name||!role){alert("Fill all fields");return;}
      currentUser={id,name,role};
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");

      // Show user info
      document.getElementById("userInfo").innerText = `ID: ${currentUser.id} | Name: ${currentUser.name} | Role: ${currentUser.role}`;

      if(role==="OFFICER"){ 
        document.getElementById("officerSection").classList.remove("hidden"); 
        document.getElementById("assignedOverview").classList.remove("hidden");
      } else { 
        document.getElementById("officerSection").classList.add("hidden"); 
      }
      updateLoginTime();
      renderAttendance();
      renderTasks();
      updateProdDatePill();
    }

    function updateLoginTime(){
      const now=new Date();
      document.getElementById("loginTime").innerText = "Login Time: "+ now.toLocaleString();
    }

    function signOut(){
      currentUser=null;
      document.getElementById("app").classList.add("hidden");
      document.getElementById("loginPage").classList.remove("hidden");
      document.getElementById("allDoneMsg").classList.add("hidden");
      document.getElementById("userInfo").innerText="";
    }

    function handleFile(e){
      const file=e.target.files[0];
      const reader=new FileReader();
      reader.onload=function(evt){
        const data=new Uint8Array(evt.target.result);
        const workbook=XLSX.read(data,{type:'array'});
        const sheet=workbook.Sheets[workbook.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(sheet);
        allTasks=json.map(r=>({
          ata:r["ATA"]||"",
          card:r["TASK CARD NUM/ AMM REF"]||"",
          description:r["TASK DESCRIPTION"]||"",
          tools:r["TOOLS / TESTSET"]||"",
          consumables:r["CONSUMABLES / MSL"]||"",
          remarks:r["REMARKS"]||"",
          manhour:r["DURATION MANHOUR"]||"",
          due:r["DUE"]||"",
          assignedTo:"",
          done:false
        }));
        availableATAs=[...new Set(allTasks.map(t=>t.ata).filter(v=>v))];
        renderTasks();
      };
      reader.readAsArrayBuffer(file);
    }

    function renderAttendance(){
      const div=document.getElementById("attendanceSection");
      div.innerHTML="<h3>LAE Attendance</h3>";
      let today=new Date().toLocaleDateString("en-US",{weekday:'short'});
      staffNames.forEach(name=>{
        let present=(laeRoster[name]||[]).includes(today);
        attendance[name]=present;
        let p=document.createElement("p");
        p.textContent=`${name}: ${present ? "Present ‚úÖ" : "Off ‚ùå"}`;
        div.appendChild(p);
      });
    }

    function showSection(id){
      document.querySelectorAll(".container > div").forEach(d=>d.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      document.getElementById("allDoneMsg").classList.add("hidden");
      renderTasks();
    }

    function renderTasks(){
      let ataFilter=document.getElementById("ataSelect")?.value||"ALL";
      let filterFn=t=>(ataFilter==="ALL"||t.ata==ataFilter);
      let sections={allTasks:[], assignedTasks:[], doneTasks:[]};

      allTasks.forEach((t,i)=>{
        if(filterFn(t)){
          if(t.done){sections.doneTasks.push([t,i]);}
          else{
            sections.allTasks.push([t,i]);
            if(t.assignedTo===currentUser?.name){sections.assignedTasks.push([t,i]);}
          }
        }
      });

      // LAE done message
      if(currentUser?.role==="LAE"){
        const userAssigned=allTasks.filter(t=>t.assignedTo===currentUser.name);
        const userDone=userAssigned.filter(t=>t.done);
        if(userAssigned.length>0 && userAssigned.length===userDone.length){
          document.getElementById("allDoneMsg").classList.remove("hidden");
        }
      }

      // Officer assigned task overview & productivity from task data
      if(currentUser?.role==="OFFICER"){
        let overviewDiv=document.getElementById("overviewList");
        let laeTasks={};
        allTasks.forEach(t=>{
          if(t.assignedTo){ 
            if(!laeTasks[t.assignedTo]) laeTasks[t.assignedTo]=[];
            laeTasks[t.assignedTo].push(`${t.card} - ${t.description} ${t.done?'‚úÖ':''}`);
          }
        });
        overviewDiv.innerHTML="";
        for(let lae in laeTasks){
          let ul=document.createElement("ul");
          laeTasks[lae].forEach(task=>{ let li=document.createElement("li"); li.textContent=task; ul.appendChild(li); });
          let div=document.createElement("div");
          div.innerHTML=`<b>${lae}:</b>`; 
          div.appendChild(ul);
          overviewDiv.appendChild(div);
        }

        // Productivity Dashboard (task-based)
        let tbody=document.getElementById("productivityBody");
        tbody.innerHTML="";
        staffNames.forEach(name=>{
          let assigned=allTasks.filter(t=>t.assignedTo===name).length;
          let done=allTasks.filter(t=>t.assignedTo===name && t.done).length;
          let percent=assigned>0? Math.round(done/assigned*100) : 0;
          let tr=document.createElement("tr");
          tr.innerHTML=`<td>${name}</td><td>${assigned}</td><td>${done}</td><td>${percent}%</td>`;
          tbody.appendChild(tr);
        });
      }

      // Render task cards
      for(let sec in sections){
        let cont=document.getElementById(sec);
        cont.innerHTML="";
        sections[sec].forEach(([t,i])=>{
          let canMark=(currentUser.role==="LAE" && t.assignedTo===currentUser.name && attendance[t.assignedTo]);
          let card=document.createElement("div");
          card.className="task-card"+(t.done?" done":"");
          card.innerHTML=`
            <div class="task-header">ATA ${t.ata}</div>
            <div class="block"><b>Task Card Num / AMM Ref:</b> ${t.card}</div>
            <div class="block"><b>Task Description:</b> ${t.description}</div>
            <div class="block"><b>Tools / Testset:</b> ${t.tools}</div>
            <div class="block"><b>Consumables / MSL:</b> ${t.consumables}</div>
            <div class="block"><b>Remarks:</b> ${t.remarks}</div>
            <div class="row">
              <div class="meta-pill">Duration / Manhour: ${t.manhour||"N/A"}</div>
              <div class="meta-pill">Due: ${t.due||"N/A"}</div>
              <div class="meta-pill">Assigned To: <span class="${t.assignedTo?'assigned-bold':''}">${t.assignedTo||"None"}</span></div>
            </div>
            <div class="task-actions">
              ${ currentUser?.role==="OFFICER"
                ? `Assign:
                    <select onchange="assign(${i}, this.value)">
                      <option value="">Assign to...</option>
                      ${staffNames.map(n=>`<option value="${n}" ${t.assignedTo===n?'selected':''}>${n}</option>`).join("")}
                    </select>` : `` }
              ${ canMark
                ? `<label><input type="checkbox" ${t.done?"checked":""}
                      onchange="markDone(${i}, this.checked)"> Mark Done</label>` : `` }
            </div>`;
          cont.appendChild(card);
        });
      }
      populateATAFilter();
    }

    function assign(i,name){ 
      if(currentUser && currentUser.role==="OFFICER"){ 
        // Check LAE availability today (simple in-app roster guard)
        let today=new Date().toLocaleDateString("en-US",{weekday:'short'});
        if(name && !(laeRoster[name]||[]).includes(today)){
          alert(`${name} is off today!`);
          return;
        }
        allTasks[i].assignedTo=name; 
        renderTasks(); 
      } else {
        alert("Only officers can assign tasks.");
      }
    }

    function markDone(i,done){ 
      allTasks[i].done=done; 
      renderTasks(); 
    }

    function populateATAFilter(){
      let div=document.getElementById("ataFilter");
      div.innerHTML="";
      let sel=document.createElement("select");
      sel.id="ataSelect";
      sel.innerHTML='<option value="ALL">All ATA</option>';
      availableATAs.forEach(a=>{ sel.innerHTML+=`<option value="${a}">ATA ${a}</option>`; });
      sel.onchange=()=>renderTasks();
      div.appendChild(sel);
    }

    function toggleOverview(){
      const ov=document.getElementById("overviewList");
      ov.classList.toggle("hidden");
    }

    // --------------------------
    // NEW: Productivity Dashboard (Roster Upload)
    // --------------------------
    function updateProdDatePill(){
      const nowMY = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kuala_Lumpur'}));
      const nice = nowMY.toLocaleDateString('en-GB', { weekday:'short', day:'2-digit', month:'short', year:'numeric', timeZone:'Asia/Kuala_Lumpur' });
      document.getElementById('prodDatePill').textContent = `Date: ${nice} (MYT)`;
    }

    function handleRosterFile(e){
      const file = e.target.files[0];
      if(!file){ return; }
      const reader = new FileReader();
      reader.onload = function(evt){
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, { type:'array' });

        // Prefer "KUL" if it exists; otherwise first sheet
        const targetSheetName = wb.SheetNames.includes("KUL") ? "KUL" : wb.SheetNames[0];
        const sheet = wb.Sheets[targetSheetName];

        // 2D matrix for robust parsing
        const mat = XLSX.utils.sheet_to_json(sheet, { header:1, raw:true });
        rosterMatrix = mat;
        detectHeaderAndNameColumn();
        computeTodayOnOff();
        renderProdLists();
        renderProdStats();
        renderRosterPreview();
      };
      reader.readAsArrayBuffer(file);
    }

    function detectHeaderAndNameColumn(){
      rosterHeaderRow = -1; rosterNameCol = 0;
      // Find a row that contains many day numbers 1..31 (typical roster layout)
      let bestRow = -1, bestCount = -1;
      for(let r=0; r<Math.min(rosterMatrix.length, 10); r++){
        let row = rosterMatrix[r]||[];
        let count = row.reduce((acc,cell)=> acc + (isDayNumber(cell)?1:0), 0);
        if(count>bestCount){ bestCount=count; bestRow=r; }
      }
      rosterHeaderRow = bestRow >= 0 ? bestRow : 0;

      // Try find "Name" column, else assume first column
      let nameCol = 0;
      const headerCandidates = [rosterHeaderRow-1, rosterHeaderRow, rosterHeaderRow+1].filter(x=>x>=0);
      for(const hr of headerCandidates){
        const row = rosterMatrix[hr]||[];
        for(let c=0;c<row.length;c++){
          const v = (row[c]||"").toString().trim().toLowerCase();
          if(v==="name" || v==="employee" || v==="staff" || v==="lae"){
            nameCol = c; break;
          }
        }
      }
      rosterNameCol = nameCol;
    }

    function isDayNumber(cell){
      if(cell == null) return false;
      // number 1..31 or string "1".."31"
      if(typeof cell === 'number') return cell>=1 && cell<=31;
      const s = cell.toString().trim();
      if(!s) return false;
      const n = parseInt(s,10);
      return !isNaN(n) && n>=1 && n<=31;
    }

    function getTodayDayNumberMYT(){
      const nowMY = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Kuala_Lumpur'}));
      return nowMY.getDate(); // day of month 1..31
    }

    function findTodayColumnIndex(){
      if(rosterHeaderRow<0 || rosterMatrix.length===0) return -1;
      const header = rosterMatrix[rosterHeaderRow] || [];
      const d = getTodayDayNumberMYT();

      // exact match first (number), then string
      for(let c=0;c<header.length;c++){
        if(typeof header[c]==='number' && header[c]===d) return c;
      }
      for(let c=0;c<header.length;c++){
        if((header[c]||"").toString().trim()===String(d)) return c;
      }
      // fallback: try zero-padded day ("01")
      for(let c=0;c<header.length;c++){
        if((header[c]||"").toString().trim()===String(d).padStart(2,'0')) return c;
      }
      return -1;
    }

    function computeTodayOnOff(){
      workingToday = []; offToday = [];
      const col = findTodayColumnIndex();
      if(col<0) { 
        console.error("Could not find today's column in roster");
        return; 
      }

      // Start scanning rows after header to the end
      for(let r=rosterHeaderRow+1; r<rosterMatrix.length; r++){
        const row = rosterMatrix[r]||[];
        let name = (row[rosterNameCol]||"").toString().trim();
        if(!name) continue; // skip blank rows

        let code = row[col];
        if(code == null) code = "";
        code = code.toString().trim().toUpperCase();

        const offCodes = ['OFF','AL','SL','ML','EL','PH','MC','OFFDAY','OFF DAY','LEAVE','HOL','PHL','ANNUAL LEAVE','SICK LEAVE'];
        const isOff = (code==="" || offCodes.includes(code));
        if(isOff){
          offToday.push({name, code: code || '‚Äî'});
        } else {
          workingToday.push({name, code});
        }
      }

      // Sort alphabetically
      workingToday.sort((a,b)=> a.name.localeCompare(b.name));
      offToday.sort((a,b)=> a.name.localeCompare(b.name));
    }

    function renderProdLists(){
      const w = document.getElementById('workingList');
      const o = document.getElementById('offList');
      w.innerHTML=""; o.innerHTML="";

      workingToday.forEach(item=>{
        const div=document.createElement('div');
        div.className='name-item';
        div.dataset.name=item.name.toLowerCase();
        div.textContent=`${item.name} (${item.code})`;
        w.appendChild(div);
      });
      offToday.forEach(item=>{
        const div=document.createElement('div');
        div.className='name-item';
        div.dataset.name=item.name.toLowerCase();
        div.textContent=`${item.name} (${item.code})`;
        o.appendChild(div);
      });
    }

    function renderProdStats(){
      const total = workingToday.length + offToday.length;
      const workPct = total ? Math.round(workingToday.length/total*100) : 0;
      const offPct = total ? (100-workPct) : 0;
      document.getElementById('prodCountsPill').textContent =
        `Total LAEs: ${total} | Working: ${workingToday.length} (${workPct}%) | Off: ${offToday.length} (${offPct}%)`;
    }

    function filterProdLists(){
      const q = document.getElementById('prodSearch').value.trim().toLowerCase();
      ['workingList','offList'].forEach(id=>{
        const parent = document.getElementById(id);
        Array.from(parent.children).forEach(child=>{
          const name = child.dataset.name || '';
          child.style.display = name.includes(q) ? '' : 'none';
        });
      });
    }

    function toggleRosterPreview(){
      rosterPreviewVisible = !rosterPreviewVisible;
      const el = document.getElementById('rosterPreview');
      el.classList.toggle('hidden', !rosterPreviewVisible);
      if(rosterPreviewVisible) renderRosterPreview();
    }

    function renderRosterPreview(){
      const el = document.getElementById('rosterPreview');
      if(!el) return;
      if(!rosterPreviewVisible) return; // only render when visible

      // Build small preview table (up to 30 rows x 20 cols for performance)
      const maxRows = Math.min(rosterMatrix.length, 30);
      const maxCols = Math.min((rosterMatrix[0]||[]).length, 20);
      let html = '<table class="preview"><thead><tr>';
      for(let c=0;c<maxCols;c++){
        const head = (rosterMatrix[rosterHeaderRow]||[])[c];
        html += `<th>${(head==null?'':head)}</th>`;
      }
      html += '</tr></thead><tbody>';
      for(let r=rosterHeaderRow+1; r<maxRows; r++){
        html += '<tr>';
        for(let c=0;c<maxCols;c++){
          const v = rosterMatrix[r] && rosterMatrix[r][c] != null ? rosterMatrix[r][c] : '';
          html += `<td>${v}</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      el.innerHTML = html;
    }

    // Initial date pill
    updateProdDatePill();
  </script>
</body>
</html>