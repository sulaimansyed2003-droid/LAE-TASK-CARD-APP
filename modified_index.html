
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Batik Air Task Card App</title>


  <style>
    /* The original CSS is kept intact, I will skip it for brevity... */
  </style>
</head>
<body>
  <header>
    <h1>Batik Air Task Card System</h1>
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>
  </header>

  <!-- Mobile menu -->
  <div id="mobileMenu" class="mobile-menu">
    <button onclick="showSection('allTasks'); hideMobileMenu()">All Tasks</button>
    <button onclick="showSection('assignedTasks'); hideMobileMenu()">Assigned Tasks</button>
    <button onclick="showSection('doneTasks'); hideMobileMenu()">Done</button>
    <button onclick="showSection('prodDash'); hideMobileMenu()">Productivity Dashboard</button>
    <button onclick="showSection('attendanceSection'); hideMobileMenu()">Attendance</button>
    <button onclick="showSection('commonDefects', this)">Common Defects</button>
    <button class="sign-out" onclick="signOut(); hideMobileMenu()">Sign Out</button>
  </div>

  <!-- LOGIN -->
  <div id="loginPage" class="login-box">
    <h2>Sign In</h2>
    <input type="text" id="idInput" placeholder="Enter your ID (e.g., 12345)" />
    <select id="nameInput"><option value="">Loading names...</option></select>
    <select id="roleInput">
      <option value="">Select Role</option>
      <option value="OFFICER">Officer</option>
      <option value="LAE">LAE</option>
    </select>
    <button id="signInBtn">Sign In</button>
    <div id="loginTime"></div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden container">
    <div id="userInfo"></div>
    <nav>
      <button onclick="showSection('allTasks',this)">All Tasks</button>
      <button onclick="showSection('assignedTasks', this)">Assigned Tasks</button>
      <button onclick="showSection('doneTasks', this)">Done</button>
      <button onclick="showSection('prodDash', this)">Productivity Dashboard</button>
      <button onclick="showSection('attendanceSection', this)">Attendance</button>
      <button onclick="signOut()">Sign Out</button>
      <button onclick="showSection('approvalSection', this)">Approval</button>
      <button onclick="showSection('commonDefects', this)">Common Defects</button>
    </nav>

    <div id="officerSection" class="hidden" style="margin-top:12px;">
      <h3>Officer Panel</h3>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <div>
          <label>Upload Task Excel (.xlsx)</label><br/>
          <input type="file" id="fileInput" accept=".xlsx" />
        </div>
        <div id="assignedOverview" class="hidden" style="flex:1;">
          <h4>Assigned Tasks Overview</h4>
          <button class="btn-toggle" onclick="toggleOverview()">Show/Hide Assigned Tasks</button>
          <div id="overviewList" class="hidden" style="margin-top:8px;"></div>
        </div>
      </div>

    <div style="margin-top:16px;">
      <!-- Enhanced Attendance Section -->
      <div id="attendanceSection" class="hidden">
        <h3>LAE Attendance</h3>
        
        <div class="attendance-controls">
          <div>
            <label for="attendanceDate">Select Date: </label>
            <input type="date" id="attendanceDate" style="padding:6px;">
          </div>
          <button class="btn-toggle" onclick="loadAttendanceForDate()">Load Attendance</button>
          <button class="btn-toggle" onclick="markAllPresent()">Mark All Present</button>
          <button class="btn-toggle" onclick="saveAttendance()">Save Attendance</button>
        </div>
        
        <div class="attendance-summary">
          <h4>Attendance Summary</h4>
          <div id="attendanceStats">Present: 0 | Absent: 0 | Off: 0 | Total: 0</div>
        </div>
        
        <div class="table-wrap">
          <table class="attendance-table">
            <thead>
              <tr>
                <th>LAE Name</th>
                <th>Scheduled</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="attendanceList">
              <!-- Will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>


      <div id="approvalSection" class="hidden" style="margin-top:16px;">
       <h3>Officer Approval Panel</h3>
       <p class="muted">Here you can approve tasks that are still pending.</p>
       <div id="approvalList"></div>
       <button class="btn-toggle" onclick="approveAllPending()">Approve All Pending</button>
      </div>

      <div id="allTasks" style="margin-top:12px;"></div>
      <div id="assignedTasks" class="hidden" style="margin-top:12px;"></div>
      <div id="doneTasks" class="hidden" style="margin-top:12px;"></div>
      <div id="allDoneMsg" class="hidden">ðŸŽ‰ All assigned tasks are done for now!</div>

    </div>

    <div style="margin-top:10px;">
      <input type="text" id="taskSearch" placeholder="Search tasks..." style="padding:8px;width:60%;" />
      <button id="exportBtn" class="btn-toggle">Export Tasks (JSON)</button>
    </div>


    <!-- ðŸ”¹ Firebase SDKs (MUST be before your code) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBJUABbLzFwgIs1bVquqS6J1rH8bglPT0A",
        authDomain: "lae-task-card.firebaseapp.com",
        projectId: "lae-task-card",
        storageBucket: "lae-task-card.firebasestorage.app",
        messagingSenderId: "240040374142",
        appId: "1:240040374142:web:9afffe133bd1a594394d2f",
        measurementId: "G-YF70MKH6BG"
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
    </script>

    <script>
      // ---------- App state ----------
      const staffNames = [
        "ABDUL FATAH BIN IBRAHIM","MOHD HAFIZ SAZWAN BIN ZAM ZAM","MOHAMMAD ZULKIFLEE BIN HUSSIN",
        "DING JU SHENG","LEE YOONG JUN","MUHAMMAD NAZIF BIN ABDUL MALEK"
      ];

      let allTasks = []; // task objects: {ata, card, description, tools, consumables, remarks, manhour, due, assignedTo, status, completedBy, completedAt, verifiedBy, verifiedAt}
      let currentUser = null;
      let availableATAs = [];
      let attendanceRecords = {}; // Format: { "YYYY-MM-DD": { "LAE Name": "present"/"absent", ... } }
      let currentAttendanceDate = new Date().toISOString().split('T')[0];

      // ---------- Utilities ----------

      // Save data to Firestore
      async function saveAppData() {
        try {
          const data = { tasks: allTasks, attendanceRecords };
          await setDoc(doc(window.db, "appData", "batikAir"), data);
          console.log("âœ… Data saved to Firestore");
        } catch (e) {
          console.error("âŒ Firestore save failed:", e);
        }
      }

      // Load data from Firestore (once)
      async function loadSavedData() {
        try {
          const snap = await getDoc(doc(window.db, "appData", "batikAir"));
          if (snap.exists()) {
            const data = snap.data();
            if (data.tasks) allTasks = data.tasks;
            if (data.attendanceRecords) attendanceRecords = data.attendanceRecords;
            availableATAs = [...new Set(allTasks.map(t => t.ata).filter(Boolean))];
            renderTasks();
          }
        } catch (e) {
          console.error("âŒ Firestore load failed:", e);
        }
      }

      // Live updates (sync across devices)
      function enableRealtimeSync() {
        const unsub = onSnapshot(doc(window.db, "appData", "batikAir"), (snap) => {
          if (snap.exists()) {
            const data = snap.data();
            if (data.tasks) allTasks = data.tasks;
            if (data.attendanceRecords) attendanceRecords = data.attendanceRecords;
            availableATAs = [...new Set(allTasks.map(t => t.ata).filter(Boolean))];
            renderTasks();
          }
        });
      }


      // Set clock
      function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleString();
      }
      setInterval(updateClock, 1000);
      updateClock();
    </script>


    <script>
      // Task handling logic including checkbox updates
      function markTaskDoneByLAE(index) {
        if (allTasks[index].status !== "pending") return;
        
        allTasks[index].status = "submitted";
        allTasks[index].completedBy = currentUser.name;
        allTasks[index].completedAt = new Date();
        
        saveAppData();
        renderTasks();
      }

      function verifyTaskByOfficer(index, approved) {
        if (allTasks[index].status !== "submitted") return;
        
        if (approved) {
          allTasks[index].status = "verified";
          allTasks[index].verifiedBy = currentUser.name;
          allTasks[index].verifiedAt = new Date();
        } else {
          allTasks[index].status = "pending";
          allTasks[index].completedBy = "";
          allTasks[index].completedAt = null;
        }
        
        saveAppData();
        renderTasks();
        checkAllTasksVerified();
      }

      // Add listener for checkbox change
      const checkbox = document.querySelector('input[type="checkbox"]');
      checkbox.addEventListener('change', () => {
        markTaskDoneByLAE(checkbox.dataset.index);
      });

    </script>

  </body>
</html>
